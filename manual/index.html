<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="generator" content="hevea 2.00">
<style type="text/css">
.li-itemize{margin:1ex 0ex;}
.li-enumerate{margin:1ex 0ex;}
.dd-description{margin:0ex 0ex 1ex 4ex;}
.dt-description{margin:0ex;}
.toc{list-style:none;}
.footnotetext{margin:0ex; padding 0ex;}
div.footnotetext P{margin:0px; text-indent:1em;}
.thefootnotes{text-align:left;margin:0ex;}
.dt-thefootnotes{margin:0em;}
.dd-thefootnotes{margin:0em 0em 0em 2em;}
.footnoterule{margin:1em auto 1em 0px;width:50%;}
.caption{padding-left:2ex; padding-right:2ex; margin-left:auto; margin-right:auto}
.title{margin:2ex auto;text-align:center}
.center{text-align:center;margin-left:auto;margin-right:auto;}
.flushleft{text-align:left;margin-left:0ex;margin-right:auto;}
.flushright{text-align:right;margin-left:auto;margin-right:0ex;}
div table{margin-left:inherit;margin-right:inherit;margin-bottom:2px;margin-top:2px}
td table{margin:auto;}
table{border-collapse:collapse;}
td{padding:0;}
.cellpadding0 tr td{padding:0;}
.cellpadding1 tr td{padding:1px;}
pre{text-align:left;margin-left:0ex;margin-right:auto;}
blockquote{margin-left:4ex;margin-right:4ex;text-align:left;}
td p{margin:0px;}
.boxed{border:1px solid black}
.textboxed{border:1px solid black}
.vbar{border:none;width:2px;background-color:black;}
.hbar{border:none;height:2px;width:100%;background-color:black;}
.hfill{border:none;height:1px;width:200%;background-color:black;}
.vdisplay{border-collapse:separate;border-spacing:2px;width:auto; empty-cells:show; border:2px solid red;}
.vdcell{white-space:nowrap;padding:0px border:2px solid green;}
.display{border-collapse:separate;border-spacing:2px;width:auto; border:none;}
.dcell{white-space:nowrap;padding:0px border:none;}
.dcenter{margin:0ex auto;}
.vdcenter{border:solid #FF8000 2px; margin:0ex auto;}
.minipage{text-align:left; margin-left:0em; margin-right:auto;}
.marginpar{border:solid thin black; width:20%; text-align:left;}
.marginparleft{float:left; margin-left:0ex; margin-right:1ex;}
.marginparright{float:right; margin-left:1ex; margin-right:0ex;}
.theorem{text-align:left;margin:1ex auto 1ex 0ex;}
.part{margin:2ex auto;text-align:center}
.lstlisting{font-family:monospace;white-space:pre;margin-right:auto;margin-left:0pt;text-align:left}
body{width:600px;margin:auto;padding-top:20px;text-align: justify;}
</style>
<title>User Manual
</title>
</head>
<body >
<!--HEVEA command line is: hevea -I .. manual.tex -->
<!--CUT STYLE article--><!--CUT DEF section 1 --><table class="title"><tr><td><h1 class="titlemain">User Manual</h1><h3 class="titlerest">Dominik Charousset</h3></td></tr>
</table><!--TOC section id=sec1 Contents-->
<h2 id="sec1" class="section">Contents</h2><!--SEC END --><ul class="toc"><li class="li-toc">
<a href="#sec2">1  Introduction</a>
<ul class="toc"><li class="li-toc">
<a href="#sec3">1.1  Actor Model</a>
</li><li class="li-toc"><a href="#sec4">1.2  Terminology</a>
<ul class="toc"><li class="li-toc">
<a href="#sec5">1.2.1  Actor</a>
</li><li class="li-toc"><a href="#sec6">1.2.2  Actor Address</a>
</li><li class="li-toc"><a href="#sec7">1.2.3  Actor Handle</a>
</li><li class="li-toc"><a href="#sec8">1.2.4  Untyped Actors</a>
</li><li class="li-toc"><a href="#sec9">1.2.5  Typed Actor</a>
</li><li class="li-toc"><a href="#sec10">1.2.6  Spawning</a>
</li><li class="li-toc"><a href="#sec11">1.2.7  Monitoring</a>
</li><li class="li-toc"><a href="#sec12">1.2.8  Link</a>
</li></ul>
</li></ul>
</li><li class="li-toc"><a href="#sec13">2  First Steps</a>
<ul class="toc"><li class="li-toc">
<a href="#sec14">2.1  Features Overview</a>
</li><li class="li-toc"><a href="#sec15">2.2  Supported Compilers</a>
</li><li class="li-toc"><a href="#sec16">2.3  Supported Operating Systems</a>
</li><li class="li-toc"><a href="#sec17">2.4  Hello World Example</a>
</li></ul>
</li><li class="li-toc"><a href="#sec18">3  Actors</a>
<ul class="toc"><li class="li-toc">
<a href="#sec19">3.1  Implicit <span style="font-family:monospace">self</span> Pointer</a>
</li><li class="li-toc"><a href="#sec20">3.2  Interface</a>
</li></ul>
</li><li class="li-toc"><a href="#sec21">4  Sending Messages</a>
<ul class="toc"><li class="li-toc">
<a href="#sec22">4.1  Replying to Messages</a>
</li><li class="li-toc"><a href="#sec23">4.2  Delaying Messages</a>
</li><li class="li-toc"><a href="#sec24">4.3  Forwarding Messages in Untyped Actors</a>
</li></ul>
</li><li class="li-toc"><a href="#sec25">5  Receiving Messages</a>
<ul class="toc"><li class="li-toc">
<a href="#sec26">5.1  Class-based actors</a>
</li><li class="li-toc"><a href="#sec27">5.2  Nesting Receives Using <code>become</code><code>/</code><code>unbecome</code></a>
</li><li class="li-toc"><a href="#sec28">5.3  Timeouts</a>
</li><li class="li-toc"><a href="#sec29">5.4  Skipping Messages</a>
</li></ul>
</li><li class="li-toc"><a href="#sec30">6  Synchronous Communication</a>
<ul class="toc"><li class="li-toc">
<a href="#sec31">6.1  Error Messages</a>
</li><li class="li-toc"><a href="#sec32">6.2  Receive Response Messages</a>
</li><li class="li-toc"><a href="#sec33">6.3  Synchronous Failures and Error Handlers</a>
<ul class="toc"><li class="li-toc">
<a href="#sec34">6.3.1  Continuations for Event-based Actors</a>
</li></ul>
</li></ul>
</li><li class="li-toc"><a href="#sec35">7  Management &amp; Error Detection</a>
<ul class="toc"><li class="li-toc">
<a href="#sec36">7.1  Links</a>
</li><li class="li-toc"><a href="#sec37">7.2  Monitors</a>
</li><li class="li-toc"><a href="#sec38">7.3  Error Codes</a>
</li><li class="li-toc"><a href="#sec39">7.4  Attach Cleanup Code to an Actor</a>
</li></ul>
</li><li class="li-toc"><a href="#sec40">8  Spawning Actors</a>
</li><li class="li-toc"><a href="#sec41">9  Message Priorities</a>
</li><li class="li-toc"><a href="#sec42">10  Network Transparency</a>
<ul class="toc"><li class="li-toc">
<a href="#sec43">10.1  Publishing of Actors</a>
</li><li class="li-toc"><a href="#sec44">10.2  Connecting to Remote Actors</a>
</li></ul>
</li><li class="li-toc"><a href="#sec45">11  Group Communication</a>
<ul class="toc"><li class="li-toc">
<a href="#sec46">11.1  Anonymous Groups</a>
</li><li class="li-toc"><a href="#sec47">11.2  Local Groups</a>
</li><li class="li-toc"><a href="#sec48">11.3  Spawn Actors in Groups</a>
</li></ul>
</li><li class="li-toc"><a href="#sec49">12  Platform-Independent Type System</a>
<ul class="toc"><li class="li-toc">
<a href="#sec50">12.1  User-Defined Data Types in Messages</a>
</li></ul>
</li><li class="li-toc"><a href="#sec51">13  Blocking API</a>
<ul class="toc"><li class="li-toc">
<a href="#sec52">13.1  Receiving Messages</a>
</li><li class="li-toc"><a href="#sec53">13.2  Receiving Synchronous Responses</a>
</li></ul>
</li><li class="li-toc"><a href="#sec54">14  Strongly Typed Actors</a>
<ul class="toc"><li class="li-toc">
<a href="#sec55">14.1  Spawning Typed Actors</a>
</li><li class="li-toc"><a href="#sec56">14.2  Class-based Typed Actors</a>
</li></ul>
</li><li class="li-toc"><a href="#sec57">15  Common Pitfalls</a>
<ul class="toc"><li class="li-toc">
<a href="#sec58">15.1  Event-Based API</a>
</li><li class="li-toc"><a href="#sec59">15.2  Synchronous Messages</a>
</li><li class="li-toc"><a href="#sec60">15.3  Sending Messages</a>
</li><li class="li-toc"><a href="#sec61">15.4  Sharing</a>
</li><li class="li-toc"><a href="#sec62">15.5  Constructors of Class-based Actors</a>
</li></ul>
</li><li class="li-toc"><a href="#sec63">16  Appendix</a>
<ul class="toc"><li class="li-toc">
<a href="#sec64">16.1  Class <span style="font-family:monospace">option</span></a>
</li><li class="li-toc"><a href="#sec65">16.2  Using <span style="font-family:monospace">aout</span> – A Concurrency-safe Wrapper for <span style="font-family:monospace">cout</span></a>
</li></ul>
</li></ul>
<!--TOC section id=sec2 Introduction-->
<h2 id="sec2" class="section">1  Introduction</h2><!--SEC END --><p>Before diving into the API of <span style="font-style:italic">Boost.Actor</span>, we would like to take the opportunity to discuss the concepts behind <span style="font-style:italic">Boost.Actor</span> and to explain the terminology used in this manual.</p>
<!--TOC subsection id=sec3 Actor Model-->
<h3 id="sec3" class="subsection">1.1  Actor Model</h3><!--SEC END --><p>The actor model describes concurrent entities – actors – that do not share state and communicate only via message passing.
By decoupling concurrently running software components via message passing, the actor model avoids race conditions by design.
Actors can create – “spawn” – new actors and monitor each other to build fault-tolerant, hierarchical systems.
Since message passing is network transparent, the actor model applies to both concurrency and distribution.</p><p>When dealing with dozens of cores, mutexes, semaphores and other threading primitives are the wrong level of abstraction.
Implementing applications on top of those primitives has proven challenging and error-prone.
Additionally, mutex-based implementations can cause queueing and unmindful access to (even distinct) data from separate threads in parallel can lead to false sharing – both decreasing performance significantly, up to the point that an application actually runs slower when adding more cores.</p><p>The actor model has gained momentum over the last decade due to its high level of abstraction and its ability to make efficient use of multicore and multiprocessor machines.
However, the actor model has not yet been widely adopted in the native programming domain.
With <span style="font-style:italic">Boost.Actor</span>, we contribute a library for actor programming in C++ as open source software to ease native development of concurrent as well as distributed systems.
In this regard, <span style="font-style:italic">Boost.Actor</span> follows the C++ philosophy “building the highest abstraction possible without sacrificing performance”.</p>
<!--TOC subsection id=sec4 Terminology-->
<h3 id="sec4" class="subsection">1.2  Terminology</h3><!--SEC END --><p>You will find that <span style="font-style:italic">Boost.Actor</span> has not simply adopted exiting implementations based on the actor model such as Erlang or the Akka library.
Instead, <span style="font-style:italic">Boost.Actor</span> aims to provide a modern C++ API allowing for type-safe as well as dynamically typed messaging.
Hence, most aspects of our system are familiar to developers having experience with other actor systems, but there are also slight differences in terminology.
However, neither <span style="font-style:italic">Boost.Actor</span> nor this manual require any foreknowledge.</p>
<!--TOC subsubsection id=sec5 Actor-->
<h4 id="sec5" class="subsubsection">1.2.1  Actor</h4><!--SEC END --><p>An actor is a lightweight abstraction for a task.
It is independent in its execution and can thus run in parallel with any number of concurrent actors.
Actors communicate only via message passing and can monitor each other to build reliable, distributed software.</p>
<!--TOC subsubsection id=sec6 Actor Address-->
<h4 id="sec6" class="subsubsection">1.2.2  Actor Address</h4><!--SEC END --><p>In <span style="font-style:italic">Boost.Actor</span>, each actor has a (network-wide) unique logical address that can be used to identify and monitor it.
However, the address can <em>not</em> be used to send a message to an actor.
This limitation is due to the fact that the address does not contain any type information about the actor.
Hence, it would not be safe to send it any message, because the actor might use a strictly typed messaging interface not accepting the given message.</p>
<!--TOC subsubsection id=sec7 Actor Handle-->
<h4 id="sec7" class="subsubsection">1.2.3  Actor Handle</h4><!--SEC END --><p>An actor handle contains the address of an actor along with its type information.
In order to send an actor a message, one needs to have a handle to it – the address alone is not sufficient.
The distinction between handles and addresses – which is unique to <span style="font-style:italic">Boost.Actor</span> when comparing it to other actor systems – is a consequence of the design decision to support both untyped and typed actors.</p>
<!--TOC subsubsection id=sec8 Untyped Actors-->
<h4 id="sec8" class="subsubsection">1.2.4  Untyped Actors</h4><!--SEC END --><p>An untyped actor does not constrain the type of messages it receives, i.e., a handle to an untyped actor accepts any kind of message.
That does of course not mean that untyped actors must handle all possible types of messages.
Choosing typed vs untyped actors is mostly a matter of taste.
Untyped actors allow developers to build prototypes faster, while typed actors allow the compiler to fetch more errors at compile time.</p>
<!--TOC subsubsection id=sec9 Typed Actor-->
<h4 id="sec9" class="subsubsection">1.2.5  Typed Actor</h4><!--SEC END --><p>A typed actor defines its messaging interface, i.e., both input and output types, in its type.
This allows the compiler to check message types statically.</p>
<!--TOC subsubsection id=sec10 Spawning-->
<h4 id="sec10" class="subsubsection">1.2.6  Spawning</h4><!--SEC END --><p>“Spawning” an actor means to create and run a new actor.</p>
<!--TOC subsubsection id=sec11 Monitoring-->
<h4 id="sec11" class="subsubsection">1.2.7  Monitoring</h4><!--SEC END --><p>
<a id="sec:monitoring"></a></p><p>A monitored actor sends a “down message” to all actors monitoring it as part of its termination.
This allows actors to supervise other actors and to take measures when one of the supervised actors failed, i.e., terminated with a non-normal exit reason.</p>
<!--TOC subsubsection id=sec12 Link-->
<h4 id="sec12" class="subsubsection">1.2.8  Link</h4><!--SEC END --><p>A link is bidirectional connection between two actors.
Each actor sends an “exit message” to all of its links as part of its termination.
Unlike down messages (cf. <a href="#sec%3Amonitoring">1.2.7</a>), the default behavior for received exit messages causes the receiving actor to terminate for the same reason if the link has failed, i.e., terminated with a non-normal exit reason.
This allows developers to create a set of actors with the guarantee that either all or no actors are alive.
The default behavior can be overridden, i.e., exit message can be “trapped”.
When trapping exit messages, they are received as any other ordinary message and can be handled by the actor.
</p>
<!--TOC section id=sec13 First Steps-->
<h2 id="sec13" class="section">2  First Steps</h2><!--SEC END --><p>To compile <span style="font-style:italic">Boost.Actor</span>, you will need CMake and a C++11 compiler. To get and compile the sources, open a terminal (on Linux or Mac OS X) and type:</p><pre class="verbatim">git clone git://github.com/Neverlord/libcppa.git
cd libcppa
./configure
make
make install [as root, optional]
</pre><p>It is recommended to run the unit tests as well:</p><pre class="verbatim">make test
</pre><p>Please submit a bug report that includes (a) your compiler version, (b) your OS, and (c) the content of the file <span style="font-family:monospace">build/Testing/Temporary/LastTest.log</span> if an error occurs.</p>
<!--TOC subsection id=sec14 Features Overview-->
<h3 id="sec14" class="subsection">2.1  Features Overview</h3><!--SEC END --><ul class="itemize"><li class="li-itemize">
Lightweight, fast and efficient actor implementations
</li><li class="li-itemize">Network transparent messaging
</li><li class="li-itemize">Error handling based on Erlang’s failure model
</li><li class="li-itemize">Pattern matching for messages as internal DSL to ease development
</li><li class="li-itemize">Thread-mapped actors for soft migration of existing applications
</li><li class="li-itemize">Publish/subscribe group communication
</li></ul>
<!--TOC subsection id=sec15 Supported Compilers-->
<h3 id="sec15" class="subsection">2.2  Supported Compilers</h3><!--SEC END --><ul class="itemize"><li class="li-itemize">
GCC ≥ 4.7
</li><li class="li-itemize">Clang ≥ 3.2
</li></ul>
<!--TOC subsection id=sec16 Supported Operating Systems-->
<h3 id="sec16" class="subsection">2.3  Supported Operating Systems</h3><!--SEC END --><ul class="itemize"><li class="li-itemize">
Linux
</li><li class="li-itemize">Mac OS X
</li><li class="li-itemize">Windows
</li></ul>
<!--TOC subsection id=sec17 Hello World Example-->
<h3 id="sec17" class="subsection">2.4  Hello World Example</h3><!--SEC END --><div class="lstlisting"><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> &lt;</span><span style="font-size:small">string</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> &lt;</span><span style="font-size:small">iostream</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"cppa/cppa.hpp"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">namespace</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">namespace</span></span><span style="font-size:small"> </span><span style="font-size:small">cppa</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">mirror</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// return the (initial) actor behavior</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// a handler for messages containing a single string</span></span></span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// that replies with a string</span></span></span><span style="font-size:small">
</span><span style="font-size:small">        [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">what</span><span style="font-size:small">) -&gt; </span><span style="font-size:small">string</span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// prints "Hello World!" via aout</span></span></span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// (thread-safe cout wrapper)</span></span></span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small">what</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// terminates this actor</span></span></span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ('become' otherwise loops forever)</span></span></span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">quit</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// reply "!dlroW olleH"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">string</span><span style="font-size:small">(</span><span style="font-size:small">what</span><span style="font-size:small">.</span><span style="font-size:small">rbegin</span><span style="font-size:small">(), </span><span style="font-size:small">what</span><span style="font-size:small">.</span><span style="font-size:small">rend</span><span style="font-size:small">());</span><span style="font-size:small">
</span><span style="font-size:small">        }</span><span style="font-size:small">
</span><span style="font-size:small">    };</span><span style="font-size:small">
</span><span style="font-size:small">}</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">hello_world</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">actor</span><span style="font-size:small">&amp; </span><span style="font-size:small">buddy</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// send "Hello World!" to our buddy ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">sync_send</span><span style="font-size:small">(</span><span style="font-size:small">buddy</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"Hello World!"</span></span></span><span style="font-size:small">).</span><span style="font-size:small">then</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ... wait for a response ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">        [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">what</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ... and print it</span></span></span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small">what</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">        }</span><span style="font-size:small">
</span><span style="font-size:small">    );</span><span style="font-size:small">
</span><span style="font-size:small">}</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">main</span><span style="font-size:small">() {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// create a new actor that calls 'mirror()'</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">mirror_actor</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">(</span><span style="font-size:small">mirror</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// create another actor that calls 'hello_world(mirror_actor)';</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">spawn</span><span style="font-size:small">(</span><span style="font-size:small">hello_world</span><span style="font-size:small">, </span><span style="font-size:small">mirror_actor</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// wait until all other actors we have spawned are done</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">await_all_actors_done</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// run cleanup code before exiting main</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">shutdown</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div>
<!--TOC section id=sec18 Actors-->
<h2 id="sec18" class="section">3  Actors</h2><!--SEC END --><p><span style="font-style:italic">Boost.Actor</span> provides several actor implementations, each covering a particular use case.
The class <code>local_actor</code> is the base class for all implementations, except for (remote) proxy actors.
Hence, <code>local_actor</code> provides a common interface for actor operations like trapping exit messages or finishing execution.
The default actor implementation in <span style="font-style:italic">Boost.Actor</span> is event-based.
Event-based actors have a very small memory footprint and are thus very lightweight and scalable.
Context-switching actors are used for actors that make use of the blocking API (see Section <a href="#Sec%3A%3ABlockingAPI">13</a>), but do not need to run in a separate thread.
Context-switching and event-based actors are scheduled cooperatively in a thread pool.
Thread-mapped actors can be used to opt-out of this cooperative scheduling.</p>
<!--TOC subsection id=sec19 Implicit <span style="font-family:monospace">self</span> Pointer-->
<h3 id="sec19" class="subsection">3.1  Implicit <span style="font-family:monospace">self</span> Pointer</h3><!--SEC END --><p>When using a function or functor to implement an actor, the first argument <em>can</em> be used to capture a pointer to the actor itself.
The type of this pointer is <code>event_based_actor</code><code>*</code> per default and <code>blocking_actor</code><code>*</code> when using the <code>blocking_api</code> flag.
When dealing with typed actors, the types are <code>typed_event_based_actor</code><code>&lt;...&gt;*</code> and <code>typed_blocking_actor</code><code>&lt;...&gt;*</code>.</p>
<!--TOC subsection id=sec20 Interface-->
<h3 id="sec20" class="subsection">3.2  Interface</h3><!--SEC END --><div class="lstlisting"><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">local_actor</span><span style="font-size:small">;</span></div><table style="border-spacing:6px;border-collapse:separate;width:100%" class="cellpading0"><tr><td style="vertical-align:middle;text-align:left;"  colspan=2><span style="font-size:large"><span style="font-weight:bold">Member functions</span></span><span style="font-size:small"> </span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">&nbsp;</span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">quit</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small"><span style="color:blue">uint32_t</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">reason</span></code><code><span style="font-size:small"> = </span></code><code><span style="font-size:small">normal</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Finishes execution of this actor </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">&nbsp;</span></td></tr>
<tr><td style="text-align:left;white-space:nowrap"  colspan=2><span style="font-size:small"><span style="font-weight:bold">Observers</span></span><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">bool</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">trap_exit</span></code><code><span style="font-size:small">()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Checks whether this actor traps exit messages </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">any_tuple</span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">last_dequeued</span></code><code><span style="font-size:small">()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Returns the last message that was dequeued from the actor’s mailbox<br>
</span><span style="font-size:small"><span style="font-weight:bold">Note</span></span><span style="font-size:small">: Only set during callback invocation </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">actor_addr</span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">last_sender</span></code><code><span style="font-size:small">()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Returns the sender of the last dequeued message<br>
</span><span style="font-size:small"><span style="font-weight:bold">Note</span></span><span style="font-size:small">: Only set during callback invocation </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">vector</span></code><code><span style="font-size:small">&lt;</span></code><code><span style="font-size:small">group</span></code><code><span style="font-size:small">&gt; </span></code><code><span style="font-size:small">joined_groups</span></code><code><span style="font-size:small">()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Returns all subscribed groups </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">&nbsp;</span></td></tr>
<tr><td style="text-align:left;white-space:nowrap"  colspan=2><span style="font-size:small"><span style="font-weight:bold">Modifiers</span></span><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">void</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">trap_exit</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small"><span style="color:blue">bool</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">enabled</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Enables or disables trapping of exit messages </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">void</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">join</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small"><span style="color:blue">const</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">group</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small">g</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Subscribes to group </span><code><span style="font-size:small">g</span></code><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">void</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">leave</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small"><span style="color:blue">const</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">group</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small">g</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Unsubscribes group </span><code><span style="font-size:small">g</span></code><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">void</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">on_sync_failure</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small"><span style="color:blue">auto</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">fun</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Sets a handler, i.e., a functor taking no arguments, for unexpected synchronous response messages (default action is to kill the actor for reason </span><code><span style="font-size:small">unhandled_sync_failure</span></code><span style="font-size:small">) </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">void</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">on_sync_timeout</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small"><span style="color:blue">auto</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">fun</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Sets a handler, i.e., a functor taking no arguments, for </span><code><span style="font-size:small">timed_sync_send</span></code><span style="font-size:small"> timeout messages (default action is to kill the actor for reason </span><code><span style="font-size:small">unhandled_sync_timeout</span></code><span style="font-size:small">) </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">void</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">monitor</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small">actor_ptr</span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">whom</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Adds a unidirectional monitor to </span><code><span style="font-size:small">whom</span></code><span style="font-size:small"> (see Section </span><a href="#Sec%3A%3AManagement%3A%3AMonitors"><span style="font-size:small">7.2</span></a><span style="font-size:small">) </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">void</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">demonitor</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small">actor_ptr</span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">whom</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Removes a monitor from </span><code><span style="font-size:small">whom</span></code><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">bool</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">has_sync_failure_handler</span></code><code><span style="font-size:small">()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Checks wheter this actor has a user-defined sync failure handler </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
</table>
<!--TOC section id=sec21 Sending Messages-->
<h2 id="sec21" class="section">4  Sending Messages</h2><!--SEC END --><p>
<a id="Sec::Send"></a></p><p>Messages can be sent by using the member function <code>send</code> or <code>send_tuple</code>.
The variadic template function <code>send</code> has the following signature.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">template</span></span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">typename</span></span><span style="font-size:small">... </span><span style="font-size:small">Args</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">send</span><span style="font-size:small">(</span><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">whom</span><span style="font-size:small">, </span><span style="font-size:small">Args</span><span style="font-size:small">&amp;&amp;... </span><span style="font-size:small">what</span><span style="font-size:small">);</span></div><p>The variadic template pack <code>what</code><code>...</code> is converted to a dynamically typed tuple (see Section <a href="#Sec%3A%3ATuples%3A%3ADynamicallyTypedTuples">??</a>) and then enqueued to the mailbox of <code>whom</code>.</p><p>Using the function <code>send</code> is more compact, but does not have any other benefit.
However, note that you should not use <code>send</code> if you already have an instance of <code>any_tuple</code>, because it creates a new tuple containing the old one.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">some_fun</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">other</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">(...);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">msg</span><span style="font-size:small"> = </span><span style="font-size:small">make_any_tuple</span><span style="font-size:small">(1, 2, 3);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">send</span><span style="font-size:small">(</span><span style="font-size:small">other</span><span style="font-size:small">, </span><span style="font-size:small">msg</span><span style="font-size:small">); </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// oops, creates a new tuple containing msg</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">send_tuple</span><span style="font-size:small">(</span><span style="font-size:small">other</span><span style="font-size:small">, </span><span style="font-size:small">msg</span><span style="font-size:small">); </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ok</span></span></span><span style="font-size:small">
</span><span style="font-size:small">}</span></div>
<!--TOC subsection id=sec22 Replying to Messages-->
<h3 id="sec22" class="subsection">4.1  Replying to Messages</h3><!--SEC END --><p>
<a id="Sec::Send::Reply"></a></p><p>The return value of a message handler is used as response message.
Actors can also use the result of a <code>sync_send</code> to answer to a request, as shown below.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">client</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">actor</span><span style="font-size:small">&amp; </span><span style="font-size:small">master</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">become</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"foo"</span></span></span><span style="font-size:small">, </span><span style="font-size:small">arg_match</span><span style="font-size:small">) &gt;&gt; [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">request</span><span style="font-size:small">) -&gt; </span><span style="font-size:small">string</span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">sync_send</span><span style="font-size:small">(</span><span style="font-size:small">master</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"bar"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">request</span><span style="font-size:small">).</span><span style="font-size:small">then</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">on_arg_match</span><span style="font-size:small"> &gt;&gt; [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">response</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">response</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">        }</span><span style="font-size:small">
</span><span style="font-size:small">      );</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  );</span><span style="font-size:small">
</span><span style="font-size:small">};</span></div>
<!--TOC subsection id=sec23 Delaying Messages-->
<h3 id="sec23" class="subsection">4.2  Delaying Messages</h3><!--SEC END --><p>Messages can be delayed, e.g., to implement time-based polling strategies, by using one of <code>delayed_send</code>, <code>delayed_send_tuple</code>, <code>delayed_reply</code>, or <code>delayed_reply_tuple</code>.
The following example illustrates a polling strategy using <code>delayed_send</code>.</p><div class="lstlisting"><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">poller</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">delayed_send</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">chrono</span><span style="font-size:small">::</span><span style="font-size:small">seconds</span><span style="font-size:small">(1), </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"poll"</span></span></span><span style="font-size:small">));</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"poll"</span></span></span><span style="font-size:small">)) &gt;&gt; [] {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// poll a resource</span></span></span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// schedule next polling</span></span></span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">delayed_send</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">chrono</span><span style="font-size:small">::</span><span style="font-size:small">seconds</span><span style="font-size:small">(1), </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"poll"</span></span></span><span style="font-size:small">));</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  };</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div>
<!--TOC subsection id=sec24 Forwarding Messages in Untyped Actors-->
<h3 id="sec24" class="subsection">4.3  Forwarding Messages in Untyped Actors</h3><!--SEC END --><p>The member function <code>forward_to</code> forwards the last dequeued message to an other actor.
Forwarding a synchronous message will also transfer responsibility for the request, i.e., the receiver of the forwarded message can reply as usual and the original sender of the message will receive the response.
The following diagram illustrates forwarding of a synchronous message from actor <span style="font-family:monospace">B</span> to actor <span style="font-family:monospace">C</span>.</p><pre class="verbatim"><span style="font-size:small">               A                  B                  C
               |                  |                  |
               | --(sync_send)--&gt; |                  |
               |                  | --(forward_to)-&gt; |
               |                  X                  |---\
               |                                     |   | compute
               |                                     |   | result
               |                                     |&lt;--/
               | &lt;-------------(reply)-------------- |
               |                                     X
               |---\
               |   | handle
               |   | response
               |&lt;--/
               |
               X
</span></pre><p>The forwarding is completely transparent to actor <span style="font-family:monospace">C</span>, since it will see actor <span style="font-family:monospace">A</span> as sender of the message.
However, actor <span style="font-family:monospace">A</span> will see actor <span style="font-family:monospace">C</span> as sender of the response message instead of actor <span style="font-family:monospace">B</span> and thus could recognize the forwarding by evaluating <code>self</code><code>-&gt;</code><code>last_sender</code><code>()</code>.
</p>
<!--TOC section id=sec25 Receiving Messages-->
<h2 id="sec25" class="section">5  Receiving Messages</h2><!--SEC END --><p>
<a id="Sec::Receive"></a></p><p>The current <span style="font-style:italic">behavior</span> of an actor is its response to the <span style="font-style:italic">next</span> incoming message and includes (a) sending messages to other actors, (b) creation of more actors, and (c) setting a new behavior.</p><p>An event-based actor, i.e., the default implementation in <span style="font-style:italic">Boost.Actor</span>, uses <code>become</code> to set its behavior.
The given behavior is then executed until it is replaced by another call to <code>become</code> or the actor finishes execution.</p>
<!--TOC subsection id=sec26 Class-based actors-->
<h3 id="sec26" class="subsection">5.1  Class-based actors</h3><!--SEC END --><p>A class-based actor is a subtype of <code>event_based_actor</code> and must implement the pure virtual member function <code>make_behavior</code> returning the initial behavior.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">printer</span><span style="font-size:small"> : </span><span style="font-size:small"><span style="color:blue">public</span></span><span style="font-size:small"> </span><span style="font-size:small">event_based_actor</span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">make_behavior</span><span style="font-size:small">() </span><span style="font-size:small"><span style="color:blue">override</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">others</span><span style="font-size:small">() &gt;&gt; [] {</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">cout</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">to_string</span><span style="font-size:small">(</span><span style="font-size:small">last_received</span><span style="font-size:small">()) &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">      }</span><span style="font-size:small">
</span><span style="font-size:small">    };</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">};</span></div><p>Another way to implement class-based actors is provided by the class <code>sb_actor</code> (“State-Based Actor”).
This base class simply returns <code>init_state</code> (defined in the subclass) from its implementation for <code>make_behavior</code>.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">struct</span></span><span style="font-size:small"> </span><span style="font-size:small">printer</span><span style="font-size:small"> : </span><span style="font-size:small">sb_actor</span><span style="font-size:small">&lt;</span><span style="font-size:small">printer</span><span style="font-size:small">&gt; {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">init_state</span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">others</span><span style="font-size:small">() &gt;&gt; [] {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">cout</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">to_string</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">last_received</span><span style="font-size:small">()) &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  };</span><span style="font-size:small">
</span><span style="font-size:small">};</span></div><p>Note that <code>sb_actor</code> uses the Curiously Recurring Template Pattern. Thus, the derived class must be given as template parameter.
This technique allows <code>sb_actor</code> to access the <code>init_state</code> member of a derived class.
The following example illustrates a more advanced state-based actor that implements a stack with a fixed maximum number of elements.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">fixed_stack</span><span style="font-size:small"> : </span><span style="font-size:small"><span style="color:blue">public</span></span><span style="font-size:small"> </span><span style="font-size:small">sb_actor</span><span style="font-size:small">&lt;</span><span style="font-size:small">fixed_stack</span><span style="font-size:small">&gt; {</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">friend</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">sb_actor</span><span style="font-size:small">&lt;</span><span style="font-size:small">fixed_stack</span><span style="font-size:small">&gt;;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">size_t</span></span><span style="font-size:small"> </span><span style="font-size:small">max_size</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">vector</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt; </span><span style="font-size:small">data</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">full</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">filled</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">empty</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">behavior</span><span style="font-size:small">&amp; </span><span style="font-size:small">init_state</span><span style="font-size:small"> = </span><span style="font-size:small">empty</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">public</span></span><span style="font-size:small">:</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">fixed_stack</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:blue">size_t</span></span><span style="font-size:small"> </span><span style="font-size:small">max</span><span style="font-size:small">) : </span><span style="font-size:small">max_size</span><span style="font-size:small">(</span><span style="font-size:small">max</span><span style="font-size:small">)  {</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">full</span><span style="font-size:small"> = (</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"push"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">arg_match</span><span style="font-size:small">) &gt;&gt; [=](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* discard */</span></span></span><span style="font-size:small"> },</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"pop"</span></span></span><span style="font-size:small">)) &gt;&gt; [=]() -&gt; </span><span style="font-size:small">cow_tuple</span><span style="font-size:small">&lt;</span><span style="font-size:small">atom_value</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt; {</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">result</span><span style="font-size:small"> = </span><span style="font-size:small">data</span><span style="font-size:small">.</span><span style="font-size:small">back</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small">data</span><span style="font-size:small">.</span><span style="font-size:small">pop_back</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small">become</span><span style="font-size:small">(</span><span style="font-size:small">filled</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"ok"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">result</span><span style="font-size:small">};</span><span style="font-size:small">
</span><span style="font-size:small">            }</span><span style="font-size:small">
</span><span style="font-size:small">        );</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">filled</span><span style="font-size:small"> = (</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"push"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">arg_match</span><span style="font-size:small">) &gt;&gt; [=](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">what</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small">data</span><span style="font-size:small">.</span><span style="font-size:small">push_back</span><span style="font-size:small">(</span><span style="font-size:small">what</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">if</span></span><span style="font-size:small"> (</span><span style="font-size:small">data</span><span style="font-size:small">.</span><span style="font-size:small">size</span><span style="font-size:small">() == </span><span style="font-size:small">max_size</span><span style="font-size:small">) </span><span style="font-size:small">become</span><span style="font-size:small">(</span><span style="font-size:small">full</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">            },</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"pop"</span></span></span><span style="font-size:small">)) &gt;&gt; [=]() -&gt; </span><span style="font-size:small">cow_tuple</span><span style="font-size:small">&lt;</span><span style="font-size:small">atom_value</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt; {</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">result</span><span style="font-size:small"> = </span><span style="font-size:small">data</span><span style="font-size:small">.</span><span style="font-size:small">back</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small">data</span><span style="font-size:small">.</span><span style="font-size:small">pop_back</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">if</span></span><span style="font-size:small"> (</span><span style="font-size:small">data</span><span style="font-size:small">.</span><span style="font-size:small">empty</span><span style="font-size:small">()) </span><span style="font-size:small">become</span><span style="font-size:small">(</span><span style="font-size:small">empty</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"ok"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">result</span><span style="font-size:small">};</span><span style="font-size:small">
</span><span style="font-size:small">            }</span><span style="font-size:small">
</span><span style="font-size:small">        );</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">empty</span><span style="font-size:small"> = (</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"push"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">arg_match</span><span style="font-size:small">) &gt;&gt; [=](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">what</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small">data</span><span style="font-size:small">.</span><span style="font-size:small">push_back</span><span style="font-size:small">(</span><span style="font-size:small">what</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small">become</span><span style="font-size:small">(</span><span style="font-size:small">filled</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">            },</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"pop"</span></span></span><span style="font-size:small">)) &gt;&gt; [=] {</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"failure"</span></span></span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">            }</span><span style="font-size:small">
</span><span style="font-size:small">        );</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">};</span></div>
<!--TOC subsection id=sec27 Nesting Receives Using <code>become</code><code>/</code><code>unbecome</code>-->
<h3 id="sec27" class="subsection">5.2  Nesting Receives Using <code>become</code><code>/</code><code>unbecome</code></h3><!--SEC END --><p>Since <code>become</code> does not block, an actor has to manipulate its behavior stack to achieve nested receive operations.
An actor can set a new behavior by calling <code>become</code> with the <code>keep_behavior</code> policy to be able to return to its previous behavior later on by calling <code>unbecome</code>, as shown in the example below.</p><div class="lstlisting"><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// receives {int, float} sequences</span></span></span><span style="font-size:small">
</span><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">testee</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">    [=](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">value1</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">become</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// the keep_behavior policy stores the current behavior</span></span></span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// on the behavior stack to be able to return to this</span></span></span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// behavior later on by calling unbecome()</span></span></span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">keep_behavior</span><span style="font-size:small">,</span><span style="font-size:small">
</span><span style="font-size:small">        [=](</span><span style="font-size:small"><span style="color:blue">float</span></span><span style="font-size:small"> </span><span style="font-size:small">value2</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small">cout</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">value1</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">" =&gt; "</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">value2</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// restore previous behavior</span></span></span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">unbecome</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">        }</span><span style="font-size:small">
</span><span style="font-size:small">      );</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  };</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div><p>An event-based actor finishes execution with normal exit reason if the behavior stack is empty after calling <code>unbecome</code>.
The default policy of <code>become</code> is <code>discard_behavior</code> that causes an actor to override its current behavior.
The policy flag must be the first argument of <code>become</code>.</p><p><span style="font-weight:bold">Note</span>: the message handling in <span style="font-style:italic">Boost.Actor</span> is consistent among all actor implementations: unmatched messages are <span style="font-style:italic">never</span> implicitly discarded if no suitable handler was found.
Hence, the order of arrival is not important in the example above.
This is unlike other event-based implementations of the actor model such as Akka for instance.</p>
<!--TOC subsection id=sec28 Timeouts-->
<h3 id="sec28" class="subsection">5.3  Timeouts</h3><!--SEC END --><p>
<a id="Sec::Receive::Timeouts"></a></p><p>A behavior set by <code>become</code> is invoked whenever a new messages arrives.
If no message ever arrives, the actor would wait forever.
This might be desirable if the actor only provides a service and should not do anything else.
But often, we need to be able to recover if an expected messages does not arrive within a certain time period. The following examples illustrates the usage of <code>after</code> to define a timeout.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> &lt;</span><span style="font-size:small">chrono</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> &lt;</span><span style="font-size:small">iostream</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"cppa/cppa.hpp"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">eager_actor</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">    [](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">i</span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> },</span><span style="font-size:small">
</span><span style="font-size:small">    [](</span><span style="font-size:small"><span style="color:blue">float</span></span><span style="font-size:small"> </span><span style="font-size:small">i</span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> },</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">others</span><span style="font-size:small">() &gt;&gt; [] { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> },</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">after</span><span style="font-size:small">(</span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">chrono</span><span style="font-size:small">::</span><span style="font-size:small">seconds</span><span style="font-size:small">(10)) &gt;&gt; [] {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"received nothing within 10 seconds..."</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  };</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div><p>Callbacks given as timeout handler must have zero arguments.
Any number of patterns can precede the timeout definition, but “<code>after</code>” must always be the final statement.
Using a zero-duration timeout causes the actor to scan its mailbox once and then invoke the timeout immediately if no matching message was found.</p><p><span style="font-style:italic">Boost.Actor</span> supports timeouts using <code>minutes</code>, <code>seconds</code>, <code>milliseconds</code> and <code>microseconds</code>.
However, note that the precision depends on the operating system and your local work load.
Thus, you should not depend on a certain clock resolution.</p>
<!--TOC subsection id=sec29 Skipping Messages-->
<h3 id="sec29" class="subsection">5.4  Skipping Messages</h3><!--SEC END --><p>Unmatched messages are skipped automatically by <span style="font-style:italic">Boost.Actor</span>’s runtime system.
This is true for <span style="font-style:italic">all</span> actor implementations.
To allow actors to skip messages manually, <code>skip_message</code> can be used.
This is in particular useful whenever an actor switches between behaviors, but wants to use a default rule created by <code>others</code><code>()</code> to filter messages that are not handled by any of its behaviors.</p><p>The following example illustrates a simple server actor that dispatches requests to workers.
After receiving an <code><span style="color:#007F00"><code>'idle'</code></span></code> message, it awaits a request that is then forwarded to the idle worker.
Afterwards, the server returns to its initial behavior, i.e., awaits the next <code><span style="color:#007F00"><code>'idle'</code></span></code> message.
The server actor will exit for reason <code>user_defined</code> whenever it receives a message that is neither a request, nor an idle message.</p><div class="lstlisting"><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">server</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">die</span><span style="font-size:small"> = [=] { </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">quit</span><span style="font-size:small">(</span><span style="font-size:small">exit_reason</span><span style="font-size:small">::</span><span style="font-size:small">user_defined</span><span style="font-size:small">); };</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"idle"</span></span></span><span style="font-size:small">)) &gt;&gt; [=] {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">worker</span><span style="font-size:small"> = </span><span style="font-size:small">last_sender</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">become</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">keep_behavior</span><span style="font-size:small">,</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"request"</span></span></span><span style="font-size:small">)) &gt;&gt; [=] {</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// forward request to idle worker</span></span></span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">forward_to</span><span style="font-size:small">(</span><span style="font-size:small">worker</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// await next idle message</span></span></span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">unbecome</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">        },</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"idle"</span></span></span><span style="font-size:small">)) &gt;&gt; </span><span style="font-size:small">skip_message</span><span style="font-size:small">,</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">others</span><span style="font-size:small">() &gt;&gt; </span><span style="font-size:small">die</span><span style="font-size:small">
</span><span style="font-size:small">      );</span><span style="font-size:small">
</span><span style="font-size:small">    },</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"request"</span></span></span><span style="font-size:small">)) &gt;&gt; </span><span style="font-size:small">skip_message</span><span style="font-size:small">,</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">others</span><span style="font-size:small">() &gt;&gt; </span><span style="font-size:small">die</span><span style="font-size:small">
</span><span style="font-size:small">  };</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div>
<!--TOC section id=sec30 Synchronous Communication-->
<h2 id="sec30" class="section">6  Synchronous Communication</h2><!--SEC END --><p>
<a id="Sec::Sync"></a></p><p><span style="font-style:italic">Boost.Actor</span> supports both asynchronous and synchronous communication.
The member functions <code>sync_send</code> and <code>sync_send_tuple</code> send synchronous request messages.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">template</span></span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">typename</span></span><span style="font-size:small">... </span><span style="font-size:small">Args</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small">__unspecified__</span><span style="font-size:small"> </span><span style="font-size:small">sync_send</span><span style="font-size:small">(</span><span style="font-size:small">actor_ptr</span><span style="font-size:small"> </span><span style="font-size:small">whom</span><span style="font-size:small">, </span><span style="font-size:small">Args</span><span style="font-size:small">&amp;&amp;... </span><span style="font-size:small">what</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">__unspecified__</span><span style="font-size:small"> </span><span style="font-size:small">sync_send_tuple</span><span style="font-size:small">(</span><span style="font-size:small">actor_ptr</span><span style="font-size:small"> </span><span style="font-size:small">whom</span><span style="font-size:small">, </span><span style="font-size:small">any_tuple</span><span style="font-size:small"> </span><span style="font-size:small">what</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">template</span></span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">typename</span></span><span style="font-size:small"> </span><span style="font-size:small">Duration</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">typename</span></span><span style="font-size:small">... </span><span style="font-size:small">Args</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small">__unspecified__</span><span style="font-size:small"> </span><span style="font-size:small">timed_sync_send</span><span style="font-size:small">(</span><span style="font-size:small">actor_ptr</span><span style="font-size:small"> </span><span style="font-size:small">whom</span><span style="font-size:small">,</span><span style="font-size:small">
</span><span style="font-size:small">                                </span><span style="font-size:small">Duration</span><span style="font-size:small"> </span><span style="font-size:small">timeout</span><span style="font-size:small">,</span><span style="font-size:small">
</span><span style="font-size:small">                                </span><span style="font-size:small">Args</span><span style="font-size:small">&amp;&amp;... </span><span style="font-size:small">what</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">template</span></span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">typename</span></span><span style="font-size:small"> </span><span style="font-size:small">Duration</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">typename</span></span><span style="font-size:small">... </span><span style="font-size:small">Args</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small">__unspecified__</span><span style="font-size:small"> </span><span style="font-size:small">timed_sync_send_tuple</span><span style="font-size:small">(</span><span style="font-size:small">actor_ptr</span><span style="font-size:small"> </span><span style="font-size:small">whom</span><span style="font-size:small">,</span><span style="font-size:small">
</span><span style="font-size:small">                                      </span><span style="font-size:small">Duration</span><span style="font-size:small"> </span><span style="font-size:small">timeout</span><span style="font-size:small">,</span><span style="font-size:small">
</span><span style="font-size:small">                                      </span><span style="font-size:small">any_tuple</span><span style="font-size:small"> </span><span style="font-size:small">what</span><span style="font-size:small">);</span></div><p>A synchronous message is sent to the receiving actor’s mailbox like any other asynchronous message.
The response message, on the other hand, is treated separately.</p><p>The difference between <code>sync_send</code> and <code>timed_sync_send</code> is how timeouts are handled.
The behavior of <code>sync_send</code> is analogous to <code>send</code>, i.e., timeouts are specified by using <code>after</code><code>(...)</code> statements (see <a href="#Sec%3A%3AReceive%3A%3ATimeouts">5.3</a>).
When using <code>timed_sync_send</code> function, <code>after</code><code>(...)</code> statements are ignored and the actor will receive a <code>sync_timeout_msg</code> after the given duration instead.</p>
<!--TOC subsection id=sec31 Error Messages-->
<h3 id="sec31" class="subsection">6.1  Error Messages</h3><!--SEC END --><p>When using synchronous messaging, <span style="font-style:italic">Boost.Actor</span>’s runtime environment will send ...</p><ul class="itemize"><li class="li-itemize">
if the receiver is not alive:<br>
<code>sync_exited_msg</code><code> { </code><code>actor_addr</code><code> </code><code>source</code><code>; </code><code>std</code><code>::</code><code><span style="color:blue">uint32_t</span></code><code> </code><code>reason</code><code>; };</code>
</li><li class="li-itemize">if a message send by <code>timed_sync_send</code> timed out: <code>sync_timeout_msg</code>
</li></ul>
<!--TOC subsection id=sec32 Receive Response Messages-->
<h3 id="sec32" class="subsection">6.2  Receive Response Messages</h3><!--SEC END --><p>When sending a synchronous message, the response handler can be passed by either using <code>then</code> (event-based actors) or <code>await</code> (blocking actors).</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">foo</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">testee</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// testee replies with a string to 'get'</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">sync_send</span><span style="font-size:small">(</span><span style="font-size:small">testee</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"get"</span></span></span><span style="font-size:small">)).</span><span style="font-size:small">then</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">on_arg_match</span><span style="font-size:small"> &gt;&gt; [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">str</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// handle str</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    },</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">after</span><span style="font-size:small">(</span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">chrono</span><span style="font-size:small">::</span><span style="font-size:small">seconds</span><span style="font-size:small">(30)) &gt;&gt; [=]() {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// handle error</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  );</span><span style="font-size:small">
</span><span style="font-size:small">);</span></div><p>Similar to <code>become</code>, the <code>then</code> function modifies an actor’s behavior stack.
However, it is used as “one-shot handler” and automatically returns to the previous behavior afterwards.</p>
<!--TOC subsection id=sec33 Synchronous Failures and Error Handlers-->
<h3 id="sec33" class="subsection">6.3  Synchronous Failures and Error Handlers</h3><!--SEC END --><p>An unexpected response message, i.e., a message that is not handled by given behavior, will invoke the actor’s <code>on_sync_failure</code> handler.
The default handler kills the actor by calling <code>self</code><code>-&gt;</code><code>quit</code><code>(</code><code>exit_reason</code><code>::</code><code>unhandled_sync_failure</code><code>)</code>.
The handler can be overridden by calling <code>self</code><code>-&gt;</code><code>on_sync_failure</code><code>(</code><code><span style="color:#7F007F"><code>/*...*/</code></span></code><code>)</code>.</p><p>Unhandled timeout messages trigger the <code>on_sync_timeout</code> handler.
The default handler kills the actor for reason <code>exit_reason</code><code>::</code><code>unhandled_sync_failure</code>.
It is possible set both error handlers by calling <code>self</code><code>-&gt;</code><code>on_sync_timeout_or_failure</code><code>(</code><code><span style="color:#7F007F"><code>/*...*)</code></span></code>.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">foo</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">testee</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// testee replies with a string to 'get'</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// set handler for unexpected messages</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">on_sync_failure</span><span style="font-size:small"> = [] {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">aout</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"received: "</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">to_string</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">last_dequeued</span><span style="font-size:small">()) &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">  };</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// set handler for timeouts</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">on_sync_timeout</span><span style="font-size:small"> = [] {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">aout</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"timeout occured"</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">  };</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// set response handler by using "then"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">timed_sync_send</span><span style="font-size:small">(</span><span style="font-size:small">testee</span><span style="font-size:small">, </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">chrono</span><span style="font-size:small">::</span><span style="font-size:small">seconds</span><span style="font-size:small">(30), </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"get"</span></span></span><span style="font-size:small">)).</span><span style="font-size:small">then</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">    [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">str</span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* handle str */</span></span></span><span style="font-size:small"> }</span><span style="font-size:small">
</span><span style="font-size:small">  );</span></div>
<!--TOC subsubsection id=sec34 Continuations for Event-based Actors-->
<h4 id="sec34" class="subsubsection">6.3.1  Continuations for Event-based Actors</h4><!--SEC END --><p><span style="font-style:italic">Boost.Actor</span> supports continuations to enable chaining of send/receive statements.
The functions <code>then</code> returns a helper object offering the member function <code>continue_with</code>, which takes a functor <span style="font-style:italic">f</span> without arguments.
After receiving a message, <span style="font-style:italic">f</span> is invoked if and only if the received messages was handled successfully, i.e., neither <code>sync_failure</code> nor <code>sync_timeout</code> occurred.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">foo</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">d_or_s</span><span style="font-size:small"> = ...; </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// replies with either a double or a string</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">sync_send</span><span style="font-size:small">(</span><span style="font-size:small">d_or_s</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"get"</span></span></span><span style="font-size:small">)).</span><span style="font-size:small">then</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">    [=](</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small"> </span><span style="font-size:small">value</span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* functor f1 */</span></span></span><span style="font-size:small"> },</span><span style="font-size:small">
</span><span style="font-size:small">    [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">value</span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* functor f2*/</span></span></span><span style="font-size:small"> }</span><span style="font-size:small">
</span><span style="font-size:small">  ).</span><span style="font-size:small">continue_with</span><span style="font-size:small">([=] {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// this continuation is invoked in both cases</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// *after* f1 or f2 is done, but *not* in case</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// of sync_failure or sync_timeout</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  });</span></div>
<!--TOC section id=sec35 Management &amp; Error Detection-->
<h2 id="sec35" class="section">7  Management &amp; Error Detection</h2><!--SEC END --><p><span style="font-style:italic">Boost.Actor</span> adapts Erlang’s well-established fault propagation model.
It allows to build actor subsystem in which either all actors are alive or have collectively failed.</p>
<!--TOC subsection id=sec36 Links-->
<h3 id="sec36" class="subsection">7.1  Links</h3><!--SEC END --><p>Linked actors monitor each other.
An actor sends an exit message to all of its links as part of its termination.
The default behavior for actors receiving such an exit message is to die for the same reason, if the exit reason is non-normal.
Actors can <span style="font-style:italic">trap</span> exit messages to handle them manually.</p><div class="lstlisting"><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">worker</span><span style="font-size:small"> = ...;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// receive exit messages as regular messages</span></span></span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">trap_exit</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:blue">true</span></span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// monitor spawned actor</span></span></span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">link_to</span><span style="font-size:small">(</span><span style="font-size:small">worker</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// wait until worker exited</span></span></span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">become</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  [](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">exit_msg</span><span style="font-size:small">&amp; </span><span style="font-size:small">e</span><span style="font-size:small">) &gt;&gt; [=] {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">if</span></span><span style="font-size:small"> (</span><span style="font-size:small">e</span><span style="font-size:small">.</span><span style="font-size:small">reason</span><span style="font-size:small"> == </span><span style="font-size:small">exit_reason</span><span style="font-size:small">::</span><span style="font-size:small">normal</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// worker finished computation</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">else</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// worker died unexpectedly</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">);</span></div>
<!--TOC subsection id=sec37 Monitors-->
<h3 id="sec37" class="subsection">7.2  Monitors</h3><!--SEC END --><p>
<a id="Sec::Management::Monitors"></a></p><p>A monitor observes the lifetime of an actor.
Monitored actors send a down message to all observers as part of their termination.
Unlike exit messages, down messages are always treated like any other ordinary message.
An actor will receive one down message for each time it called <code>self</code><code>-&gt;</code><code>monitor</code><code>(...)</code>, even if it adds a monitor to the same actor multiple times.</p><div class="lstlisting"><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">worker</span><span style="font-size:small"> = ...;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// monitor spawned actor</span></span></span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">monitor</span><span style="font-size:small">(</span><span style="font-size:small">worker</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// wait until worker exited</span></span></span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">become</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">down_msg</span><span style="font-size:small">&amp; </span><span style="font-size:small">d</span><span style="font-size:small">) &gt;&gt; [] {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">if</span></span><span style="font-size:small"> (</span><span style="font-size:small">d</span><span style="font-size:small">.</span><span style="font-size:small">reason</span><span style="font-size:small"> == </span><span style="font-size:small">exit_reason</span><span style="font-size:small">::</span><span style="font-size:small">normal</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// worker finished computation</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    } </span><span style="font-size:small"><span style="color:blue">else</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// worker died unexpectedly</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">);</span></div>
<!--TOC subsection id=sec38 Error Codes-->
<h3 id="sec38" class="subsection">7.3  Error Codes</h3><!--SEC END --><p>All error codes are defined in the namespace <code>cppa</code><code>::</code><code>exit_reason</code>.
To obtain a string representation of an error code, use <code>cppa</code><code>::</code><code>exit_reason</code><code>::</code><code>as_string</code><code>(</code><code><span style="color:blue">uint32_t</span></code><code>)</code>.</p><table style="border-spacing:6px;border-collapse:separate;width:100%" class="cellpading0"><tr><td class="hbar" colspan=3></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" > <code>normal</code></td><td style="vertical-align:middle;text-align:left;" >1</td><td style="vertical-align:middle;text-align:left;" >Actor finished execution without error </td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" > <code>unhandled_exception</code></td><td style="vertical-align:middle;text-align:left;" >2</td><td style="vertical-align:middle;text-align:left;" >Actor was killed due to an unhandled exception </td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" > <code>unallowed_function_call</code></td><td style="vertical-align:middle;text-align:left;" >3</td><td style="vertical-align:middle;text-align:left;" >Indicates that an event-based actor tried to use blocking receive calls </td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" > <code>unhandled_sync_failure</code></td><td style="vertical-align:middle;text-align:left;" >4</td><td style="vertical-align:middle;text-align:left;" >Actor was killed due to an unexpected synchronous response message </td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" > <code>unhandled_sync_timeout</code></td><td style="vertical-align:middle;text-align:left;" >5</td><td style="vertical-align:middle;text-align:left;" >Actor was killed, because no timeout handler was set and a synchronous message timed out </td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" > <code>user_shutdown</code></td><td style="vertical-align:middle;text-align:left;" >16</td><td style="vertical-align:middle;text-align:left;" >Actor was killed by a user-generated event </td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" > <code>remote_link_unreachable</code></td><td style="vertical-align:middle;text-align:left;" >257</td><td style="vertical-align:middle;text-align:left;" >Indicates that a remote actor became unreachable, e.g., due to connection error </td></tr>
<tr><td class="hbar" colspan=3></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" > <code>user_defined</code></td><td style="vertical-align:middle;text-align:left;" >65536</td><td style="vertical-align:middle;text-align:left;" >Minimum value for user-defined exit codes </td></tr>
<tr><td class="hbar" colspan=3></td></tr>
</table>
<!--TOC subsection id=sec39 Attach Cleanup Code to an Actor-->
<h3 id="sec39" class="subsection">7.4  Attach Cleanup Code to an Actor</h3><!--SEC END --><p>Actors can attach cleanup code to other actors.
This code is executed immediately if the actor has already exited.
Keep in mind that <code>self</code> refers to the currently running actor.
Thus, <code>self</code> refers to the terminating actor and not to the actor that attached a functor to it.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">worker</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">(...);</span><span style="font-size:small">
</span><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">observer</span><span style="font-size:small"> = </span><span style="font-size:small">self</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// "monitor" spawned actor</span></span></span><span style="font-size:small">
</span><span style="font-size:small">worker</span><span style="font-size:small">-&gt;</span><span style="font-size:small">attach_functor</span><span style="font-size:small">([</span><span style="font-size:small">observer</span><span style="font-size:small">](</span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small"><span style="color:blue">uint32_t</span></span><span style="font-size:small"> </span><span style="font-size:small">reason</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// this callback is invoked from worker</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">anon_send</span><span style="font-size:small">(</span><span style="font-size:small">observer</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"DONE"</span></span></span><span style="font-size:small">));</span><span style="font-size:small">
</span><span style="font-size:small">});</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// wait until worker exited</span></span></span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">become</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"DONE"</span></span></span><span style="font-size:small">)) &gt;&gt; [] {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// worker terminated</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">);</span></div><p><span style="font-weight:bold">Note</span>: It is possible to attach code to remote actors, but the cleanup code will run on the local machine.

</p>
<!--TOC section id=sec40 Spawning Actors-->
<h2 id="sec40" class="section">8  Spawning Actors</h2><!--SEC END --><p>Actors are created using the function <code>spawn</code>.
The easiest way to implement actors is to use functors, e.g., a free function or lambda expression.
The arguments to the functor are passed to <code>spawn</code> as additional arguments.
The function <code>spawn</code> also takes optional flags as template parameter.
The flag <code>detached</code> causes <code>spawn</code> to create a thread-mapped actor (opt-out of the cooperative scheduling), the flag <code>linked</code> links the newly created actor to its parent – not available on top-level spawn – and the flag <code>monitored</code> automatically adds a monitor to the new actor.
Actors that make use of the blocking API (see Section <a href="#Sec%3A%3ABlockingAPI">13</a>) must be spawned using the flag <code>blocking_api</code>.
Flags are concatenated using the operator <code>+</code>, as shown in the examples below.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"cppa/cppa.hpp"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">namespace</span></span><span style="font-size:small"> </span><span style="font-size:small">cppa</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">my_actor1</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">my_actor2</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">*, </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">arg1</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">arg2</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">ugly_duckling</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">my_actor3</span><span style="font-size:small"> : </span><span style="font-size:small"><span style="color:blue">public</span></span><span style="font-size:small"> </span><span style="font-size:small">event_based_actor</span><span style="font-size:small"> { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> };</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">my_actor4</span><span style="font-size:small"> : </span><span style="font-size:small"><span style="color:blue">public</span></span><span style="font-size:small"> </span><span style="font-size:small">sb_actor</span><span style="font-size:small">&lt;</span><span style="font-size:small">my_actor4</span><span style="font-size:small">&gt; {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">public</span></span><span style="font-size:small">: </span><span style="font-size:small">my_actor4</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">some_value</span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> }</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small">
</span><span style="font-size:small">};</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// whenever we want to link to or monitor a spawned actor,</span></span></span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// we have to spawn it using the self pointer, otherwise</span></span></span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// we can use the free function 'spawn' (top-level spawn)</span></span></span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">server</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// spawn function-based actors</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a0</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">(</span><span style="font-size:small">my_actor1</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a1</span><span style="font-size:small"> = </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">linked</span><span style="font-size:small">&gt;(</span><span style="font-size:small">my_actor2</span><span style="font-size:small">, 42, </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"hello actor"</span></span></span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a2</span><span style="font-size:small"> = </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">monitored</span><span style="font-size:small">&gt;([] { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> });</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a3</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">([](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> }, 42);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// spawn thread-mapped actors</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a4</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">detached</span><span style="font-size:small">&gt;(</span><span style="font-size:small">my_actor1</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a5</span><span style="font-size:small"> = </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">detached</span><span style="font-size:small"> + </span><span style="font-size:small">linked</span><span style="font-size:small">&gt;([] { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> });</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a6</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">detached</span><span style="font-size:small">&gt;(</span><span style="font-size:small">my_actor2</span><span style="font-size:small">, 0, </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"zero"</span></span></span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// spawn class-based actors</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a7</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">my_actor3</span><span style="font-size:small">&gt;();</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a8</span><span style="font-size:small"> = </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">my_actor4</span><span style="font-size:small">, </span><span style="font-size:small">monitored</span><span style="font-size:small">&gt;(42);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// spawn thread-mapped actors using a class</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a9</span><span style="font-size:small"> = </span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">my_actor4</span><span style="font-size:small">, </span><span style="font-size:small">detached</span><span style="font-size:small">&gt;(42);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// spawn actors that need access to the blocking API</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">aa</span><span style="font-size:small"> = </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">blocking_api</span><span style="font-size:small">&gt;(</span><span style="font-size:small">ugly_duckling</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// compiler error: my_actor2 captures the implicit</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// self pointer as event_based_actor* and thus cannot</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// be spawned using blocking_api flag</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/*-auto ab = self-&gt;spawn&lt;blocking_api&gt;(my_actor2);-*/</span></span></span><span style="font-size:small">
</span><span style="font-size:small">}</span></div>
<!--TOC section id=sec41 Message Priorities-->
<h2 id="sec41" class="section">9  Message Priorities</h2><!--SEC END --><p>By default, all messages have the same priority and actors ignore priority flags.
Actors that should evaluate priorities must be spawned using the <code>priority_aware</code> flag.
This flag causes the actor to use a priority-aware mailbox implementation.
It is not possible to change this implementation dynamically at runtime.</p><div class="lstlisting"><span style="font-size:small">behavior</span><span style="font-size:small"> </span><span style="font-size:small">testee</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// send 'b' with normal priority</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">send</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"b"</span></span></span><span style="font-size:small">));</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// send 'a' with high priority</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">send</span><span style="font-size:small">(</span><span style="font-size:small">message_priority</span><span style="font-size:small">::</span><span style="font-size:small">high</span><span style="font-size:small">, </span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"a"</span></span></span><span style="font-size:small">));</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// terminate after receiving a 'b'</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"b"</span></span></span><span style="font-size:small">)) &gt;&gt; [=] {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"received 'b' =&gt; quit"</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">quit</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">    },</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"a"</span></span></span><span style="font-size:small">)) &gt;&gt; [=] {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"received 'a'"</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">    },</span><span style="font-size:small">
</span><span style="font-size:small">  };</span><span style="font-size:small">
</span><span style="font-size:small">}</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">main</span><span style="font-size:small">() {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// will print "received 'b' =&gt; quit"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">spawn</span><span style="font-size:small">(</span><span style="font-size:small">testee</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">await_all_actors_done</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// will print "received 'a'" and then "received 'b' =&gt; quit"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">priority_aware</span><span style="font-size:small">&gt;(</span><span style="font-size:small">testee</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">await_all_actors_done</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">shutdown</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div>
<!--TOC section id=sec42 Network Transparency-->
<h2 id="sec42" class="section">10  Network Transparency</h2><!--SEC END --><p>All actor operations as well as sending messages are network transparent.
Remote actors are represented by actor proxies that forward all messages.</p>
<!--TOC subsection id=sec43 Publishing of Actors-->
<h3 id="sec43" class="subsection">10.1  Publishing of Actors</h3><!--SEC END --><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">publish</span><span style="font-size:small">(</span><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">whom</span><span style="font-size:small">, </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">uint16_t</span><span style="font-size:small"> </span><span style="font-size:small">port</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">char</span></span><span style="font-size:small">* </span><span style="font-size:small">addr</span><span style="font-size:small"> = 0)</span></div><p>The function <code>publish</code> binds an actor to a given port.
It throws <code>network_error</code> if socket related errors occur or <code>bind_failure</code> if the specified port is already in use.
The optional <code>addr</code> parameter can be used to listen only to the given IP address.
Otherwise, the actor accepts all incoming connections (<code>INADDR_ANY</code>).</p><div class="lstlisting"><span style="font-size:small">publish</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">, 4242);</span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">become</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"ping"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">arg_match</span><span style="font-size:small">) &gt;&gt; [](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">i</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">make_cow_tuple</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"pong"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">i</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">);</span></div>
<!--TOC subsection id=sec44 Connecting to Remote Actors-->
<h3 id="sec44" class="subsection">10.2  Connecting to Remote Actors</h3><!--SEC END --><div class="lstlisting"><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">remote_actor</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">char</span></span><span style="font-size:small">* </span><span style="font-size:small">host</span><span style="font-size:small">, </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">uint16_t</span><span style="font-size:small"> </span><span style="font-size:small">port</span><span style="font-size:small">)</span></div><p>The function <code>remote_actor</code> connects to the actor at given host and port.
A <code>network_error</code> is thrown if the connection failed.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">pong</span><span style="font-size:small"> = </span><span style="font-size:small">remote_actor</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"localhost"</span></span></span><span style="font-size:small">, 4242);</span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">send</span><span style="font-size:small">(</span><span style="font-size:small">pong</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"ping"</span></span></span><span style="font-size:small">), 0);</span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">become</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"pong"</span></span></span><span style="font-size:small">), 10) &gt;&gt; [=] {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">quit</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">  },</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"pong"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">arg_match</span><span style="font-size:small">) &gt;&gt; [=](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">i</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">make_cow_tuple</span><span style="font-size:small">(</span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"ping"</span></span></span><span style="font-size:small">), </span><span style="font-size:small">i</span><span style="font-size:small">+1);</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">);</span></div>
<!--TOC section id=sec45 Group Communication-->
<h2 id="sec45" class="section">11  Group Communication</h2><!--SEC END --><p>
<a id="Sec::Group"></a></p><p><span style="font-style:italic">Boost.Actor</span> supports publish/subscribe-based group communication.
Actors can join and leave groups and send messages to groups.</p><div class="lstlisting"><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">string</span><span style="font-size:small"> </span><span style="font-size:small">group_module</span><span style="font-size:small"> = ...;</span><span style="font-size:small">
</span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">string</span><span style="font-size:small"> </span><span style="font-size:small">group_id</span><span style="font-size:small"> = ...;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">grp</span><span style="font-size:small"> = </span><span style="font-size:small">group</span><span style="font-size:small">::</span><span style="font-size:small">get</span><span style="font-size:small">(</span><span style="font-size:small">group_module</span><span style="font-size:small">, </span><span style="font-size:small">group_id</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">join</span><span style="font-size:small">(</span><span style="font-size:small">grp</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">send</span><span style="font-size:small">(</span><span style="font-size:small">grp</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"test"</span></span></span><span style="font-size:small">));</span><span style="font-size:small">
</span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">leave</span><span style="font-size:small">(</span><span style="font-size:small">grp</span><span style="font-size:small">);</span></div>
<!--TOC subsection id=sec46 Anonymous Groups-->
<h3 id="sec46" class="subsection">11.1  Anonymous Groups</h3><!--SEC END --><p>
<a id="Sec::Group::Anonymous"></a></p><p>Groups created on-the-fly with <code>group</code><code>::</code><code>anonymous</code><code>()</code> can be used to coordinate a set of workers.
Each call to <code>group</code><code>::</code><code>anonymous</code><code>()</code> returns a new, unique group instance.</p>
<!--TOC subsection id=sec47 Local Groups-->
<h3 id="sec47" class="subsection">11.2  Local Groups</h3><!--SEC END --><p>
<a id="Sec::Group::Local"></a></p><p>The <code><span style="color:#007F00"><code>"local"</code></span></code> group module creates groups for in-process communication.
For example, a group for GUI related events could be identified by <code>group</code><code>::</code><code>get</code><code>(</code><code><span style="color:#007F00"><code>"local"</code></span></code><code>, </code><code><span style="color:#007F00"><code>"GUI events"</code></span></code><code>)</code>.
The group ID <code><span style="color:#007F00"><code>"GUI events"</code></span></code> uniquely identifies a singleton group instance of the module <code><span style="color:#007F00"><code>"local"</code></span></code>.</p>
<!--TOC subsection id=sec48 Spawn Actors in Groups-->
<h3 id="sec48" class="subsection">11.3  Spawn Actors in Groups</h3><!--SEC END --><p>
<a id="Sec::Group::Spawn"></a></p><p>The function <code>spawn_in_group</code> can be used to create actors as members of a group.
The function causes the newly created actors to call <code>self</code><code>-&gt;</code><code>join</code><code>(...)</code> immediately and before <code>spawn_in_group</code> returns. 
The usage of <code>spawn_in_group</code> is equal to <code>spawn</code>, except for an additional group argument.
The group handle is always the first argument, as shown in the examples below.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">fun1</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">fun2</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">float</span></span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">my_actor1</span><span style="font-size:small"> : </span><span style="font-size:small">event_based_actor</span><span style="font-size:small"> { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> };</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">my_actor2</span><span style="font-size:small"> : </span><span style="font-size:small">event_based_actor</span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">my_actor2</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">str</span><span style="font-size:small">) { </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">/* ... */</span></span></span><span style="font-size:small"> }</span><span style="font-size:small">
</span><span style="font-size:small">};</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">grp</span><span style="font-size:small"> = </span><span style="font-size:small">group</span><span style="font-size:small">::</span><span style="font-size:small">get</span><span style="font-size:small">(...);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a1</span><span style="font-size:small"> = </span><span style="font-size:small">spawn_in_group</span><span style="font-size:small">(</span><span style="font-size:small">grp</span><span style="font-size:small">, </span><span style="font-size:small">fun1</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a2</span><span style="font-size:small"> = </span><span style="font-size:small">spawn_in_group</span><span style="font-size:small">(</span><span style="font-size:small">grp</span><span style="font-size:small">, </span><span style="font-size:small">fun2</span><span style="font-size:small">, 1, 2.0</span><span style="font-size:small">f</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a3</span><span style="font-size:small"> = </span><span style="font-size:small">spawn_in_group</span><span style="font-size:small">&lt;</span><span style="font-size:small">my_actor1</span><span style="font-size:small">&gt;(</span><span style="font-size:small">grp</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">a4</span><span style="font-size:small"> = </span><span style="font-size:small">spawn_in_group</span><span style="font-size:small">&lt;</span><span style="font-size:small">my_actor2</span><span style="font-size:small">&gt;(</span><span style="font-size:small">grp</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"hello my_actor2!"</span></span></span><span style="font-size:small">);</span></div>
<!--TOC section id=sec49 Platform-Independent Type System-->
<h2 id="sec49" class="section">12  Platform-Independent Type System</h2><!--SEC END --><p>
<a id="Sec::TypeSystem"></a></p><p><span style="font-style:italic">Boost.Actor</span> provides a fully network transparent communication between actors.
Thus, <span style="font-style:italic">Boost.Actor</span> needs to serialize and deserialize messages.
Unfortunately, this is not possible using the RTTI system of C++.
<span style="font-style:italic">Boost.Actor</span> uses its own RTTI based on the class <code>uniform_type_info</code>, since it is not possible to extend <code>std</code><code>::</code><code><span style="color:blue">type_info</span></code>.</p><p>Unlike <code>std</code><code>::</code><code><span style="color:blue">type_info</span></code><code>::</code><code>name</code><code>()</code>, <code>uniform_type_info</code><code>::</code><code>name</code><code>()</code> is guaranteed to return the same name on all supported platforms. Furthermore, it allows to create an instance of a type by name.</p><div class="lstlisting"><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// creates a signed, 32 bit integer</span></span></span><span style="font-size:small">
</span><span style="font-size:small">cppa</span><span style="font-size:small">::</span><span style="font-size:small">object</span><span style="font-size:small"> </span><span style="font-size:small">i</span><span style="font-size:small"> = </span><span style="font-size:small">cppa</span><span style="font-size:small">::</span><span style="font-size:small">uniform_typeid</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;()-&gt;</span><span style="font-size:small">create</span><span style="font-size:small">();</span></div><p>However, you should rarely if ever need to use <code>object</code> or <code>uniform_type_info</code>.</p>
<!--TOC subsection id=sec50 User-Defined Data Types in Messages-->
<h3 id="sec50" class="subsection">12.1  User-Defined Data Types in Messages</h3><!--SEC END --><p>
<a id="Sec::TypeSystem::UserDefined"></a></p><p>All user-defined types must be explicitly “announced” so that <span style="font-style:italic">Boost.Actor</span> can (de)serialize them correctly, as shown in the example below.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"cppa/cppa.hpp"</span></span></span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">namespace</span></span><span style="font-size:small"> </span><span style="font-size:small">cppa</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">struct</span></span><span style="font-size:small"> </span><span style="font-size:small">foo</span><span style="font-size:small"> { </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">a</span><span style="font-size:small">; </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">b</span><span style="font-size:small">; };</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">main</span><span style="font-size:small">() {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">announce</span><span style="font-size:small">&lt;</span><span style="font-size:small">foo</span><span style="font-size:small">&gt;(&amp;</span><span style="font-size:small">foo</span><span style="font-size:small">::</span><span style="font-size:small">a</span><span style="font-size:small">, &amp;</span><span style="font-size:small">foo</span><span style="font-size:small">::</span><span style="font-size:small">b</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ... foo can now safely be used in messages ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">}</span></div><p>Without the <code>announce</code> function call, the example program would terminate with an exception, because <span style="font-style:italic">Boost.Actor</span> rejects all types without available runtime type information.</p><p><code>announce</code><code>()</code> takes the class as template parameter and pointers to all members (or getter/setter pairs) as arguments.
This works for all primitive data types and STL compliant containers.
See the announce examples 1 – 4 of the standard distribution for more details.</p><p>Obviously, there are limitations.
You have to implement serialize/deserialize by yourself if your class does implement an unsupported data structure.
See <code>announce_example_5</code><code>.</code><code>cpp</code> in the examples folder.
</p>
<!--TOC section id=sec51 Blocking API-->
<h2 id="sec51" class="section">13  Blocking API</h2><!--SEC END --><p>
<a id="Sec::BlockingAPI"></a></p><p>Besides event-based actors (the default implementation), <span style="font-style:italic">Boost.Actor</span> also provides context-switching and thread-mapped actors that can make use of the blocking API.
Those actor implementations are intended to ease migration of existing applications or to implement actors that need to have access to blocking receive primitives for other reasons.</p><p>Event-based actors differ in receiving messages from context-switching and thread-mapped actors: the former define their behavior as a message handler that is invoked whenever a new messages arrives in the actor’s mailbox (by using <code>become</code>), whereas the latter use an explicit, blocking receive function.</p>
<!--TOC subsection id=sec52 Receiving Messages-->
<h3 id="sec52" class="subsection">13.1  Receiving Messages</h3><!--SEC END --><p>The function <code>receive</code> sequentially iterates over all elements in the mailbox beginning with the first.
It takes a partial function that is applied to the elements in the mailbox until an element was matched by the partial function.
An actor calling <code>receive</code> is blocked until it successfully dequeued a message from its mailbox or an optional timeout occurs.</p><div class="lstlisting"><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">receive</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;().</span><span style="font-size:small">when</span><span style="font-size:small">(</span><span style="font-size:small">_x1</span><span style="font-size:small"> &gt; 0) &gt;&gt; </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">);</span></div><p>The code snippet above illustrates the use of <code>receive</code>.
Note that the partial function passed to <code>receive</code> is a temporary object at runtime.
Hence, using receive inside a loop would cause creation of a new partial function on each iteration.
<span style="font-style:italic">Boost.Actor</span> provides three predefined receive loops to provide a more efficient but yet convenient way of defining receive loops.</p><table border=1  style="border-spacing:0;width:100%" class="cellpadding1"><tr><td style="vertical-align:top;text-align:left;border:solid 1px;" ><code><span style="color:#7F007F"><code>// DON'T</code></span></code></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><code><span style="color:#7F007F"><code>// DO</code></span></code> </td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="lstlisting"><span style="font-size:small"><span style="color:blue">for</span></span><span style="font-size:small"> (;;) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">receive</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  );</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="lstlisting"><span style="font-size:small">receive_loop</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// ...</span></span></span><span style="font-size:small">
</span><span style="font-size:small">);</span></div></td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="lstlisting"><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">vector</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt; </span><span style="font-size:small">results</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">for</span></span><span style="font-size:small"> (</span><span style="font-size:small"><span style="color:blue">size_t</span></span><span style="font-size:small"> </span><span style="font-size:small">i</span><span style="font-size:small"> = 0; </span><span style="font-size:small">i</span><span style="font-size:small"> &lt; 10; ++</span><span style="font-size:small">i</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">receive</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">on</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;() &gt;&gt; [&amp;](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">value</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">results</span><span style="font-size:small">.</span><span style="font-size:small">push_back</span><span style="font-size:small">(</span><span style="font-size:small">value</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  );</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="lstlisting"><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">vector</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt; </span><span style="font-size:small">results</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">size_t</span></span><span style="font-size:small"> </span><span style="font-size:small">i</span><span style="font-size:small"> = 0;</span><span style="font-size:small">
</span><span style="font-size:small">receive_for</span><span style="font-size:small">(</span><span style="font-size:small">i</span><span style="font-size:small">, 10) (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;() &gt;&gt; [&amp;](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">value</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">results</span><span style="font-size:small">.</span><span style="font-size:small">push_back</span><span style="font-size:small">(</span><span style="font-size:small">value</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">);</span></div></td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="lstlisting"><span style="font-size:small"><span style="color:blue">size_t</span></span><span style="font-size:small"> </span><span style="font-size:small">received</span><span style="font-size:small"> = 0;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">do</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">receive</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">others</span><span style="font-size:small">() &gt;&gt; [&amp;]() {</span><span style="font-size:small">
</span><span style="font-size:small">      ++</span><span style="font-size:small">received</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  );</span><span style="font-size:small">
</span><span style="font-size:small">} </span><span style="font-size:small"><span style="color:blue">while</span></span><span style="font-size:small"> (</span><span style="font-size:small">received</span><span style="font-size:small"> &lt; 10);</span></div></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="lstlisting"><span style="font-size:small"><span style="color:blue">size_t</span></span><span style="font-size:small"> </span><span style="font-size:small">received</span><span style="font-size:small"> = 0;</span><span style="font-size:small">
</span><span style="font-size:small">do_receive</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">others</span><span style="font-size:small">() &gt;&gt; [&amp;]() {</span><span style="font-size:small">
</span><span style="font-size:small">    ++</span><span style="font-size:small">received</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">).</span><span style="font-size:small">until</span><span style="font-size:small">(</span><span style="font-size:small">gref</span><span style="font-size:small">(</span><span style="font-size:small">received</span><span style="font-size:small">) &gt;= 10);</span></div></td></tr>
</table><p>The examples above illustrate the correct usage of the three loops <code>receive_loop</code>, <code>receive_for</code> and <code>do_receive</code><code>(...).</code><code>until</code>.
It is possible to nest receives and receive loops.</p><div class="lstlisting"><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">receive_loop</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;() &gt;&gt; [&amp;](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">value1</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">receive</span><span style="font-size:small"> (</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small">on</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">float</span></span><span style="font-size:small">&gt;() &gt;&gt; [&amp;](</span><span style="font-size:small"><span style="color:blue">float</span></span><span style="font-size:small"> </span><span style="font-size:small">value2</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">cout</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">value1</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">" =&gt; "</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">value2</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">      }</span><span style="font-size:small">
</span><span style="font-size:small">    );</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">);</span></div>
<!--TOC subsection id=sec53 Receiving Synchronous Responses-->
<h3 id="sec53" class="subsection">13.2  Receiving Synchronous Responses</h3><!--SEC END --><p>Analogous to <code>sync_send</code><code>(...).</code><code>then</code><code>(...)</code> for event-based actors, blocking actors can use <code>sync_send</code><code>(...).</code><code>await</code><code>(...)</code>.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">foo</span><span style="font-size:small">(</span><span style="font-size:small">blocking_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small">actor</span><span style="font-size:small"> </span><span style="font-size:small">testee</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// testee replies with a string to 'get'</span></span></span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">sync_send</span><span style="font-size:small">(</span><span style="font-size:small">testee</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"get"</span></span></span><span style="font-size:small">)).</span><span style="font-size:small">await</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">    [&amp;](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">string</span><span style="font-size:small">&amp; </span><span style="font-size:small">str</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// handle str</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    },</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">after</span><span style="font-size:small">(</span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">chrono</span><span style="font-size:small">::</span><span style="font-size:small">seconds</span><span style="font-size:small">(30)) &gt;&gt; [&amp;]() {</span><span style="font-size:small">
</span><span style="font-size:small">      </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// handle error</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">  );</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div>
<!--TOC section id=sec54 Strongly Typed Actors-->
<h2 id="sec54" class="section">14  Strongly Typed Actors</h2><!--SEC END --><p>Strongly typed actors provide a convenient way of defining type-safe messaging interfaces.
Unlike untyped actorsd, typed actors are not allowed to use guard expressions.
When calling <code>become</code> in a strongly typed actor, <em>all</em> message handlers from the typed interface must be set.</p><p>Typed actors use handles of type <code>typed_actor</code><code>&lt;...&gt;</code> rather than <code>actor</code>, whereas the template parameters hold the messaging interface.
For example, an actor responding to two integers with a dobule would use the type <code>typed_actor</code><code>&lt;</code><code>replies_to</code><code>&lt;</code><code><span style="color:blue">int</span></code><code>, </code><code><span style="color:blue">int</span></code><code>&gt;::</code><code>with</code><code>&lt;</code><code><span style="color:blue">double</span></code><code>&gt;&gt;</code>.
All functions for message passing, linking and monitoring are overloaded to accept both types of actors.</p>
<!--TOC subsection id=sec55 Spawning Typed Actors-->
<h3 id="sec55" class="subsection">14.1  Spawning Typed Actors</h3><!--SEC END --><p>
<a id="sec:strong:spawn"></a></p><p>Typed actors are spawned using the function <code>spawn_typed</code>.
The argument to this function call <em>must</em> be a match expression as shown in the example below, because the runtime of libcppa needs to evaluate the signature of each message handler.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">auto</span></span><span style="font-size:small"> </span><span style="font-size:small">p0</span><span style="font-size:small"> = </span><span style="font-size:small">spawn_typed</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on_arg_match</span><span style="font-size:small"> &gt;&gt; [](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">a</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">b</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">   </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">static_cast</span></span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">&gt;(</span><span style="font-size:small">a</span><span style="font-size:small">) * </span><span style="font-size:small">b</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">  },</span><span style="font-size:small">
</span><span style="font-size:small">  </span><span style="font-size:small">on_arg_match</span><span style="font-size:small"> &gt;&gt; [](</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small"> </span><span style="font-size:small">a</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small"> </span><span style="font-size:small">b</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">make_cow_tuple</span><span style="font-size:small">(</span><span style="font-size:small">a</span><span style="font-size:small"> * </span><span style="font-size:small">b</span><span style="font-size:small">, </span><span style="font-size:small">a</span><span style="font-size:small"> / </span><span style="font-size:small">b</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">  }</span><span style="font-size:small">
</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// assign to identical type</span></span></span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small">full_type</span><span style="font-size:small"> = </span><span style="font-size:small">typed_actor_ptr</span><span style="font-size:small">&lt;</span><span style="font-size:small">
</span><span style="font-size:small">                    </span><span style="font-size:small">replies_to</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;::</span><span style="font-size:small">with</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">&gt;,</span><span style="font-size:small">
</span><span style="font-size:small">                    </span><span style="font-size:small">replies_to</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">&gt;::</span><span style="font-size:small">with</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small">                  &gt;;</span><span style="font-size:small">
</span><span style="font-size:small">full_type</span><span style="font-size:small"> </span><span style="font-size:small">p1</span><span style="font-size:small"> = </span><span style="font-size:small">p0</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// assign to subtype</span></span></span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small">subtype1</span><span style="font-size:small"> = </span><span style="font-size:small">typed_actor_ptr</span><span style="font-size:small">&lt;</span><span style="font-size:small">
</span><span style="font-size:small">                   </span><span style="font-size:small">replies_to</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;::</span><span style="font-size:small">with</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small">                 &gt;;</span><span style="font-size:small">
</span><span style="font-size:small">subtype1</span><span style="font-size:small"> </span><span style="font-size:small">p2</span><span style="font-size:small"> = </span><span style="font-size:small">p0</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// assign to another subtype</span></span></span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small">subtype2</span><span style="font-size:small"> = </span><span style="font-size:small">typed_actor_ptr</span><span style="font-size:small">&lt;</span><span style="font-size:small">
</span><span style="font-size:small">                   </span><span style="font-size:small">replies_to</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">&gt;::</span><span style="font-size:small">with</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">double</span></span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small">                 &gt;;</span><span style="font-size:small">
</span><span style="font-size:small">subtype2</span><span style="font-size:small"> </span><span style="font-size:small">p3</span><span style="font-size:small"> = </span><span style="font-size:small">p0</span><span style="font-size:small">;</span></div>
<!--TOC subsection id=sec56 Class-based Typed Actors-->
<h3 id="sec56" class="subsection">14.2  Class-based Typed Actors</h3><!--SEC END --><p>Typed actors are spawned using the function <code>spawn_typed</code> and define their message passing interface as list of <code>replies_to</code><code>&lt;...&gt;::</code><code>with</code><code>&lt;...&gt;</code> statements.
This interface is used in (1) <code>typed_event_based_actor</code><code>&lt;...&gt;</code>, which is the base class for typed actors, (2) the handle type <code>typed_actor</code><code>&lt;...&gt;</code>, and (3) <code>typed_behavior</code><code>&lt;...&gt;</code>, i.e., the behavior definition for typed actors.
Since this is rather redundant, the actor handle provides definitions for the behavior as well as the base class, as shown in the example below.
It is worth mentioning that all typed actors always use the event-based implementation, i.e., there is no typed actor implementation providing a blocking API.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">struct</span></span><span style="font-size:small"> </span><span style="font-size:small">shutdown_request</span><span style="font-size:small"> { };</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">struct</span></span><span style="font-size:small"> </span><span style="font-size:small">plus_request</span><span style="font-size:small"> { </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">a</span><span style="font-size:small">; </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">b</span><span style="font-size:small">; };</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">struct</span></span><span style="font-size:small"> </span><span style="font-size:small">minus_request</span><span style="font-size:small"> { </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">a</span><span style="font-size:small">; </span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">b</span><span style="font-size:small">; };</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">typedef</span></span><span style="font-size:small"> </span><span style="font-size:small">typed_actor</span><span style="font-size:small">&lt;</span><span style="font-size:small">replies_to</span><span style="font-size:small">&lt;</span><span style="font-size:small">plus_request</span><span style="font-size:small">&gt;::</span><span style="font-size:small">with</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;,</span><span style="font-size:small">
</span><span style="font-size:small">                    </span><span style="font-size:small">replies_to</span><span style="font-size:small">&lt;</span><span style="font-size:small">minus_request</span><span style="font-size:small">&gt;::</span><span style="font-size:small">with</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small">&gt;,</span><span style="font-size:small">
</span><span style="font-size:small">                    </span><span style="font-size:small">replies_to</span><span style="font-size:small">&lt;</span><span style="font-size:small">shutdown_request</span><span style="font-size:small">&gt;::</span><span style="font-size:small">with</span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small">&gt;&gt;</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">calculator_type</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small">calculator_type</span><span style="font-size:small">::</span><span style="font-size:small">behavior_type</span><span style="font-size:small">
</span><span style="font-size:small">typed_calculator</span><span style="font-size:small">(</span><span style="font-size:small">calculator_type</span><span style="font-size:small">::</span><span style="font-size:small">pointer</span><span style="font-size:small"> </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">        [](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">plus_request</span><span style="font-size:small">&amp; </span><span style="font-size:small">pr</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">pr</span><span style="font-size:small">.</span><span style="font-size:small">a</span><span style="font-size:small"> + </span><span style="font-size:small">pr</span><span style="font-size:small">.</span><span style="font-size:small">b</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">        },</span><span style="font-size:small">
</span><span style="font-size:small">        [](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">minus_request</span><span style="font-size:small">&amp; </span><span style="font-size:small">pr</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">pr</span><span style="font-size:small">.</span><span style="font-size:small">a</span><span style="font-size:small"> - </span><span style="font-size:small">pr</span><span style="font-size:small">.</span><span style="font-size:small">b</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">        },</span><span style="font-size:small">
</span><span style="font-size:small">        [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">shutdown_request</span><span style="font-size:small">&amp;) {</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">quit</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">        }</span><span style="font-size:small">
</span><span style="font-size:small">    };</span><span style="font-size:small">
</span><span style="font-size:small">}</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">typed_calculator_class</span><span style="font-size:small"> : </span><span style="font-size:small"><span style="color:blue">public</span></span><span style="font-size:small"> </span><span style="font-size:small">calculator_type</span><span style="font-size:small">::</span><span style="font-size:small">base</span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">protected</span></span><span style="font-size:small">: </span><span style="font-size:small">behavior_type</span><span style="font-size:small"> </span><span style="font-size:small">make_behavior</span><span style="font-size:small">() </span><span style="font-size:small"><span style="color:blue">override</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> {</span><span style="font-size:small">
</span><span style="font-size:small">            [](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">plus_request</span><span style="font-size:small">&amp; </span><span style="font-size:small">pr</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">pr</span><span style="font-size:small">.</span><span style="font-size:small">a</span><span style="font-size:small"> + </span><span style="font-size:small">pr</span><span style="font-size:small">.</span><span style="font-size:small">b</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">            },</span><span style="font-size:small">
</span><span style="font-size:small">            [](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">minus_request</span><span style="font-size:small">&amp; </span><span style="font-size:small">pr</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> </span><span style="font-size:small">pr</span><span style="font-size:small">.</span><span style="font-size:small">a</span><span style="font-size:small"> - </span><span style="font-size:small">pr</span><span style="font-size:small">.</span><span style="font-size:small">b</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">            },</span><span style="font-size:small">
</span><span style="font-size:small">            [=](</span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">shutdown_request</span><span style="font-size:small">&amp;) {</span><span style="font-size:small">
</span><span style="font-size:small">                </span><span style="font-size:small">quit</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">            }</span><span style="font-size:small">
</span><span style="font-size:small">        };</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">};</span></div><div class="lstlisting"><span style="font-size:small"><span style="color:blue">void</span></span><span style="font-size:small"> </span><span style="font-size:small">tester</span><span style="font-size:small">(</span><span style="font-size:small">event_based_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small"><span style="color:blue">const</span></span><span style="font-size:small"> </span><span style="font-size:small">calculator_type</span><span style="font-size:small">&amp; </span><span style="font-size:small">testee</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">link_to</span><span style="font-size:small">(</span><span style="font-size:small">testee</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// will be invoked if we receive an unexpected response message</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">on_sync_failure</span><span style="font-size:small">([=] {</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"AUT (actor under test) failed"</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">quit</span><span style="font-size:small">(</span><span style="font-size:small">exit_reason</span><span style="font-size:small">::</span><span style="font-size:small">user_shutdown</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">    });</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// first test: 2 + 1 = 3</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">sync_send</span><span style="font-size:small">(</span><span style="font-size:small">testee</span><span style="font-size:small">, </span><span style="font-size:small">plus_request</span><span style="font-size:small">{2, 1}).</span><span style="font-size:small">then</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">        [=](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">r1</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:blue">assert</span></span><span style="font-size:small">(</span><span style="font-size:small">r1</span><span style="font-size:small"> == 3);</span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// second test: 2 - 1 = 1</span></span></span><span style="font-size:small">
</span><span style="font-size:small">            </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">sync_send</span><span style="font-size:small">(</span><span style="font-size:small">testee</span><span style="font-size:small">, </span><span style="font-size:small">minus_request</span><span style="font-size:small">{2, 1}).</span><span style="font-size:small">then</span><span style="font-size:small">(</span><span style="font-size:small">
</span><span style="font-size:small">                [=](</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">r2</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">                    </span><span style="font-size:small"><span style="color:blue">assert</span></span><span style="font-size:small">(</span><span style="font-size:small">r2</span><span style="font-size:small"> == 1);</span><span style="font-size:small">
</span><span style="font-size:small">                    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// both tests succeeded</span></span></span><span style="font-size:small">
</span><span style="font-size:small">                    </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"AUT (actor under test) "</span></span></span><span style="font-size:small">
</span><span style="font-size:small">                               &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"seems to be ok"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">                               &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">                    </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">send</span><span style="font-size:small">(</span><span style="font-size:small">testee</span><span style="font-size:small">, </span><span style="font-size:small">shutdown_request</span><span style="font-size:small">{});</span><span style="font-size:small">
</span><span style="font-size:small">                }</span><span style="font-size:small">
</span><span style="font-size:small">            );</span><span style="font-size:small">
</span><span style="font-size:small">        }</span><span style="font-size:small">
</span><span style="font-size:small">    );</span><span style="font-size:small">
</span><span style="font-size:small">}</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">main</span><span style="font-size:small">() {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// announce custom message types</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">announce</span><span style="font-size:small">&lt;</span><span style="font-size:small">shutdown_request</span><span style="font-size:small">&gt;();</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">announce</span><span style="font-size:small">&lt;</span><span style="font-size:small">plus_request</span><span style="font-size:small">&gt;(&amp;</span><span style="font-size:small">plus_request</span><span style="font-size:small">::</span><span style="font-size:small">a</span><span style="font-size:small">, &amp;</span><span style="font-size:small">plus_request</span><span style="font-size:small">::</span><span style="font-size:small">b</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">announce</span><span style="font-size:small">&lt;</span><span style="font-size:small">minus_request</span><span style="font-size:small">&gt;(&amp;</span><span style="font-size:small">minus_request</span><span style="font-size:small">::</span><span style="font-size:small">a</span><span style="font-size:small">, &amp;</span><span style="font-size:small">minus_request</span><span style="font-size:small">::</span><span style="font-size:small">b</span><span style="font-size:small">);</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// test function-based impl</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">spawn</span><span style="font-size:small">(</span><span style="font-size:small">tester</span><span style="font-size:small">, </span><span style="font-size:small">spawn_typed</span><span style="font-size:small">(</span><span style="font-size:small">typed_calculator</span><span style="font-size:small">));</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">await_all_actors_done</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// test class-based impl</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">spawn</span><span style="font-size:small">(</span><span style="font-size:small">tester</span><span style="font-size:small">, </span><span style="font-size:small">spawn_typed</span><span style="font-size:small">&lt;</span><span style="font-size:small">typed_calculator_class</span><span style="font-size:small">&gt;());</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">await_all_actors_done</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// done</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">shutdown</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> 0;</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div>
<!--TOC section id=sec57 Common Pitfalls-->
<h2 id="sec57" class="section">15  Common Pitfalls</h2><!--SEC END --><p>
<a id="Sec::Pitfalls"></a></p>
<!--TOC subsection id=sec58 Event-Based API-->
<h3 id="sec58" class="subsection">15.1  Event-Based API</h3><!--SEC END --><ul class="itemize"><li class="li-itemize">
The functions <code>become</code> and <code>handle_response</code> do not block, i.e., always return immediately.
Thus, one should <span style="font-style:italic">always</span> capture by value in lambda expressions, because all references on the stack will cause undefined behavior if the lambda expression is executed.
</li></ul>
<!--TOC subsection id=sec59 Synchronous Messages-->
<h3 id="sec59" class="subsection">15.2  Synchronous Messages</h3><!--SEC END --><ul class="itemize"><li class="li-itemize">A handle returned by <code>sync_send</code> represents <em>exactly one</em> response message.
Therefore, it is not possible to receive more than one response message.
</li><li class="li-itemize">The handle returned by <code>sync_send</code> is bound to the calling actor.
It is not possible to transfer a handle to a response to another actor.</li></ul>
<!--TOC subsection id=sec60 Sending Messages-->
<h3 id="sec60" class="subsection">15.3  Sending Messages</h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><code>send</code><code>(</code><code>whom</code><code>, ...)</code> is defined as <code>send_tuple</code><code>(</code><code>whom</code><code>, </code><code>make_any_tuple</code><code>(...))</code>.
Hence, a message sent via <code>send</code><code>(</code><code>whom</code><code>, </code><code>self</code><code>-&gt;</code><code>last_dequeued</code><code>())</code> will not yield the expected result, since it wraps <code>self</code><code>-&gt;</code><code>last_dequeued</code><code>()</code> into another <code>any_tuple</code> instance.
The correct way of forwarding messages is <code>self</code><code>-&gt;</code><code>forward_to</code><code>(</code><code>whom</code><code>)</code>.</li></ul>
<!--TOC subsection id=sec61 Sharing-->
<h3 id="sec61" class="subsection">15.4  Sharing</h3><!--SEC END --><ul class="itemize"><li class="li-itemize">
It is strongly recommended to <span style="font-weight:bold">not</span> share states between actors.
In particular, no actor shall ever access member variables or member functions of another actor.
Accessing shared memory segments concurrently can cause undefined behavior that is incredibly hard to find and debug.
However, sharing <span style="font-style:italic">data</span> between actors is fine, as long as the data is <span style="font-style:italic">immutable</span> and its lifetime is guaranteed to outlive all actors.
The simplest way to meet the lifetime guarantee is by storing the data in smart pointers such as <code>std</code><code>::</code><code>shared_ptr</code>.
Nevertheless, the recommended way of sharing informations is message passing.
Sending data to multiple actors does not necessarily result in copying the data several times.
Read Section <a href="#Sec%3A%3ATuples">??</a> to learn more about <span style="font-style:italic">Boost.Actor</span>’s copy-on-write optimization for tuples.
</li></ul>
<!--TOC subsection id=sec62 Constructors of Class-based Actors-->
<h3 id="sec62" class="subsection">15.5  Constructors of Class-based Actors</h3><!--SEC END --><ul class="itemize"><li class="li-itemize">
You should <span style="font-weight:bold">not</span> try to send or receive messages in a constructor or destructor, because the actor is not fully initialized at this point.
</li></ul>
<!--TOC section id=sec63 Appendix-->
<h2 id="sec63" class="section">16  Appendix</h2><!--SEC END -->
<!--TOC subsection id=sec64 Class <span style="font-family:monospace">option</span>-->
<h3 id="sec64" class="subsection">16.1  Class <span style="font-family:monospace">option</span></h3><!--SEC END --><p>
<a id="Appendix::Option"></a></p><p>Defined in header <code><span style="color:#007F00"><code>"cppa/option.hpp"</code></span></code>.</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">template</span></span><span style="font-size:small">&lt;</span><span style="font-size:small"><span style="color:blue">typename</span></span><span style="font-size:small"> </span><span style="font-size:small">T</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">class</span></span><span style="font-size:small"> </span><span style="font-size:small">option</span><span style="font-size:small">;</span></div><p>Represents an optional value.</p><table style="border-spacing:6px;border-collapse:separate;width:100%" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap"  colspan=2><span style="font-size:large"><span style="font-weight:bold">Member types</span></span><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><span style="font-size:small"><span style="font-weight:bold">Member type</span></span></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"><span style="font-weight:bold">Definition</span></span><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">type</span></code></td><td style="vertical-align:middle;text-align:left;" ><code><span style="font-size:small">T</span></code><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">&nbsp;</span></td></tr>
<tr><td style="text-align:left;white-space:nowrap"  colspan=2><span style="font-size:large"><span style="font-weight:bold">Member functions</span></span><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">option</span></code><code><span style="font-size:small">()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Constructs an empty option </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">option</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small">T</span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">value</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Initializes </span><code><span style="font-size:small"><span style="color:blue">this</span></span></code><span style="font-size:small"> with </span><code><span style="font-size:small">value</span></code><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">option</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small"><span style="color:blue">const</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">option</span></code><code><span style="font-size:small">&amp;)</span></code><span style="font-size:small"><br>
</span><code><span style="font-size:small">option</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small">option</span></code><code><span style="font-size:small">&amp;&amp;)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Copy/move construction </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">option</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small"><span style="color:blue">operator</span></span></code><code><span style="font-size:small">=(</span></code><code><span style="font-size:small"><span style="color:blue">const</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">option</span></code><code><span style="font-size:small">&amp;)</span></code><span style="font-size:small"><br>
</span><code><span style="font-size:small">option</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small"><span style="color:blue">operator</span></span></code><code><span style="font-size:small">=(</span></code><code><span style="font-size:small">option</span></code><code><span style="font-size:small">&amp;&amp;)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Copy/move assignment </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">&nbsp;</span></td></tr>
<tr><td style="text-align:left;white-space:nowrap"  colspan=2><span style="font-size:small"><span style="font-weight:bold">Observers</span></span><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">bool</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">valid</span></code><code><span style="font-size:small">()</span></code><span style="font-size:small"><br>
</span><code><span style="font-size:small"><span style="color:blue">explicit</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small"><span style="color:blue">operator</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small"><span style="color:blue">bool</span></span></code><code><span style="font-size:small">()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Returns </span><code><span style="font-size:small"><span style="color:blue">true</span></span></code><span style="font-size:small"> if </span><code><span style="font-size:small"><span style="color:blue">this</span></span></code><span style="font-size:small"> has a value </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">bool</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">empty</span></code><code><span style="font-size:small">()</span></code><span style="font-size:small"><br>
</span><code><span style="font-size:small"><span style="color:blue">bool</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small"><span style="color:blue">operator</span></span></code><code><span style="font-size:small">!()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Returns </span><code><span style="font-size:small"><span style="color:blue">true</span></span></code><span style="font-size:small"> if </span><code><span style="font-size:small"><span style="color:blue">this</span></span></code><span style="font-size:small"> does </span><span style="font-size:small"><span style="font-weight:bold">not</span></span><span style="font-size:small"> has a value </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">const</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">T</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small">get</span></code><code><span style="font-size:small">()</span></code><span style="font-size:small"><br>
</span><code><span style="font-size:small"><span style="color:blue">const</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">T</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small"><span style="color:blue">operator</span></span></code><code><span style="font-size:small">*()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Access stored value </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small"><span style="color:blue">const</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">T</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small">get_or_else</span></code><code><span style="font-size:small">(</span></code><code><span style="font-size:small"><span style="color:blue">const</span></span></code><code><span style="font-size:small"> </span></code><code><span style="font-size:small">T</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small">x</span></code><code><span style="font-size:small">)</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Returns </span><code><span style="font-size:small">get</span></code><code><span style="font-size:small">()</span></code><span style="font-size:small"> if valid, </span><code><span style="font-size:small">x</span></code><span style="font-size:small"> otherwise </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">&nbsp;</span></td></tr>
<tr><td style="text-align:left;white-space:nowrap"  colspan=2><span style="font-size:small"><span style="font-weight:bold">Modifiers</span></span><span style="font-size:small"> </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
<tr><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small"> </span><code><span style="font-size:small">T</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small">get</span></code><code><span style="font-size:small">()</span></code><span style="font-size:small"><br>
</span><code><span style="font-size:small">T</span></code><code><span style="font-size:small">&amp; </span></code><code><span style="font-size:small"><span style="color:blue">operator</span></span></code><code><span style="font-size:small">*()</span></code></td><td style="vertical-align:middle;text-align:left;" ><span style="font-size:small">Access stored value </span></td></tr>
<tr><td class="hbar" colspan=2><span style="font-size:small"></span></td></tr>
</table>
<!--TOC subsection id=sec65 Using <span style="font-family:monospace">aout</span> – A Concurrency-safe Wrapper for <span style="font-family:monospace">cout</span>-->
<h3 id="sec65" class="subsection">16.2  Using <span style="font-family:monospace">aout</span> – A Concurrency-safe Wrapper for <span style="font-family:monospace">cout</span></h3><!--SEC END --><p>When using <code>cout</code> from multiple actors, output often appears interleaved.
Moreover, using <code>cout</code> from multiple actors – and thus from multiple threads – in parallel should be avoided regardless, since the standard does not guarantee a thread-safe implementation.</p><p>By replacing <span style="font-family:monospace">std::cout</span> with <span style="font-family:monospace">cppa::aout</span>, actors can achieve a concurrency-safe text output.
The header <code>cppa</code><code>/</code><code>cppa</code><code>.</code><code>hpp</code> also defines overloads for <span style="font-family:monospace">std::endl</span> and <span style="font-family:monospace">std::flush</span> for <code>aout</code>, but does not support the full range of ostream operations (yet).
Each write operation to <span style="font-family:monospace">aout</span> sends a message to a ‘hidden’ actor (keep in mind, sending messages from actor constructors is not safe).
This actor only prints lines, unless output is forced using <code>flush</code>.
The example below illustrates printing of lines of text from multiple actors (in random order).</p><div class="lstlisting"><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> &lt;</span><span style="font-size:small">chrono</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> &lt;</span><span style="font-size:small">cstdlib</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> &lt;</span><span style="font-size:small">iostream</span><span style="font-size:small">&gt;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">#include</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"cppa/cppa.hpp"</span></span></span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small"><span style="color:blue">namespace</span></span><span style="font-size:small"> </span><span style="font-size:small">cppa</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">using</span></span><span style="font-size:small"> </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">
</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">main</span><span style="font-size:small">() {</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">srand</span><span style="font-size:small">(</span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">time</span><span style="font-size:small">(0));</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">for</span></span><span style="font-size:small"> (</span><span style="font-size:small"><span style="color:blue">int</span></span><span style="font-size:small"> </span><span style="font-size:small">i</span><span style="font-size:small"> = 1; </span><span style="font-size:small">i</span><span style="font-size:small"> &lt;= 50; ++</span><span style="font-size:small">i</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">        </span><span style="font-size:small">spawn</span><span style="font-size:small">&lt;</span><span style="font-size:small">blocking_api</span><span style="font-size:small">&gt;([</span><span style="font-size:small">i</span><span style="font-size:small">](</span><span style="font-size:small">blocking_actor</span><span style="font-size:small">* </span><span style="font-size:small">self</span><span style="font-size:small">) {</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"Hi there! This is actor nr. "</span></span></span><span style="font-size:small">
</span><span style="font-size:small">                     &lt;&lt; </span><span style="font-size:small">i</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"!"</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">chrono</span><span style="font-size:small">::</span><span style="font-size:small">milliseconds</span><span style="font-size:small"> </span><span style="font-size:small">tout</span><span style="font-size:small">{</span><span style="font-size:small">std</span><span style="font-size:small">::</span><span style="font-size:small">rand</span><span style="font-size:small">() % 1000};</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">delayed_send</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">, </span><span style="font-size:small">tout</span><span style="font-size:small">, </span><span style="font-size:small">atom</span><span style="font-size:small">(</span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"done"</span></span></span><span style="font-size:small">));</span><span style="font-size:small">
</span><span style="font-size:small">          </span><span style="font-size:small">self</span><span style="font-size:small">-&gt;</span><span style="font-size:small">receive</span><span style="font-size:small">(</span><span style="font-size:small">others</span><span style="font-size:small">() &gt;&gt; [</span><span style="font-size:small">i</span><span style="font-size:small">, </span><span style="font-size:small">self</span><span style="font-size:small">] {</span><span style="font-size:small">
</span><span style="font-size:small">              </span><span style="font-size:small">aout</span><span style="font-size:small">(</span><span style="font-size:small">self</span><span style="font-size:small">) &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">"Actor nr. "</span></span></span><span style="font-size:small">
</span><span style="font-size:small">                         &lt;&lt; </span><span style="font-size:small">i</span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small"><span style="color:#007F00"><span style="font-size:small">" says goodbye!"</span></span></span><span style="font-size:small"> &lt;&lt; </span><span style="font-size:small">endl</span><span style="font-size:small">;</span><span style="font-size:small">
</span><span style="font-size:small">          });</span><span style="font-size:small">
</span><span style="font-size:small">        });</span><span style="font-size:small">
</span><span style="font-size:small">    }</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// wait until all other actors we've spawned are done</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">await_all_actors_done</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:#7F007F"><span style="font-size:small">// done</span></span></span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small">shutdown</span><span style="font-size:small">();</span><span style="font-size:small">
</span><span style="font-size:small">    </span><span style="font-size:small"><span style="color:blue">return</span></span><span style="font-size:small"> 0;</span><span style="font-size:small">
</span><span style="font-size:small">}</span></div><!--CUT END -->
<!--HTMLFOOT-->
<!--ENDHTML-->
<!--FOOTER-->
<hr style="height:2"><blockquote class="quote"><em>This document was translated from L<sup>A</sup>T<sub>E</sub>X by
</em><a href="http://hevea.inria.fr/index.html"><em>H</em><em><span style="font-size:small"><sup>E</sup></span></em><em>V</em><em><span style="font-size:small"><sup>E</sup></span></em><em>A</em></a><em>.</em></blockquote></body>
</html>
